<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard Comercial - Métricas e Performance">
    <title>Hubstrom - Comercial</title>

    <!-- Favicon Hubstrom -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Cpath d='M161 85c2.7-1.2 5.6.8 5.6 3.7v50.3c0 1.6-.9 3-2.4 3.7L35.2 199.9c-.9.4-1.9-.3-1.9-1.2v-54.4c0-1.6.9-3 2.4-3.7L161 85z' fill='%2335CCA3'/%3E%3Cpath d='M164.8.1c.9-.4 1.9.3 1.9 1.2v54.4c0 1.6-.9 3-2.4 3.7L39 114.9c-2.7 1.2-5.6-.8-5.6-3.7V61c0-1.6.9-3 2.4-3.7L164.8.1z' fill='%2335CCA3'/%3E%3C/svg%3E">

    <!-- Estilos -->
    <link rel="stylesheet" href="css/styles.css">

    <!-- Estilos específicos para o embed -->
    <style>
        /* Header compacto — sem subtítulo, só header-top */
        .header {
            margin-bottom: 10px;
            padding: 14px 24px;
        }

        .header-top {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .dashboard-container {
            width: 100%;
            height: calc(100vh - 70px);
            background: #0f172a;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .dashboard-container iframe {
            width: calc(100% + 17px);
            height: 100%;
            border: none;
            background: #0f172a;
        }

        .dashboard-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 17px;
            height: 28px;
            background: #0f172a;
            z-index: 10;
            pointer-events: none;
        }

        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #0f172a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-overlay .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(53, 204, 163, 0.2);
            border-top-color: #35cca3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-overlay p {
            margin-top: 20px;
            color: #94a3b8;
            font-size: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Botão flutuante de IA */
        .comercial-ai-fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #35cca3, #2ba882);
            border: none;
            color: #0a0f14;
            cursor: pointer;
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 24px rgba(53, 204, 163, 0.4);
            transition: all 0.3s ease;
        }

        .comercial-ai-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 32px rgba(53, 204, 163, 0.6);
        }

        .comercial-ai-fab.active {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 6px 24px rgba(239, 68, 68, 0.4);
        }

        .comercial-ai-fab.active svg {
            transform: rotate(45deg);
        }

        /* Painel lateral de IA */
        .comercial-ai-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 520px;
            max-width: 100vw;
            height: 100vh;
            background: #0f172a;
            border-left: 1px solid rgba(53, 204, 163, 0.2);
            z-index: 300;
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.5);
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .comercial-ai-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .comercial-ai-panel-header h3 {
            color: #35cca3;
            font-size: 1.1em;
            margin: 0;
        }

        .comercial-ai-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .comercial-ai-desc {
            color: #94a3b8;
            font-size: 0.9em;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .comercial-ai-textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #e2e8f0;
            font-family: 'Segoe UI', sans-serif;
            font-size: 0.88em;
            padding: 14px;
            resize: vertical;
            min-height: 120px;
            line-height: 1.6;
        }

        .comercial-ai-textarea:focus {
            outline: none;
            border-color: rgba(53, 204, 163, 0.5);
        }

        .comercial-ai-textarea::placeholder {
            color: #4a5568;
        }

        .comercial-gid-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 8px;
        }

        .comercial-gid-field {
            flex: 1;
        }

        .comercial-gid-field label {
            display: block;
            font-size: 0.8em;
            color: #94a3b8;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .comercial-gid-field input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 0.9em;
            padding: 10px 12px;
        }

        .comercial-gid-field input:focus {
            outline: none;
            border-color: rgba(53, 204, 163, 0.5);
        }

        .btn-fetch-sheets {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #35cca3, #2ba882);
            color: #0a0f14;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85em;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .btn-fetch-sheets:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(53, 204, 163, 0.3);
        }

        .btn-fetch-sheets:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-fetch-sheets.loading svg {
            animation: spin 1s linear infinite;
        }

        .comercial-fetch-status {
            display: block;
            font-size: 0.8em;
            margin-bottom: 4px;
            min-height: 18px;
        }

        .comercial-ai-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .comercial-ai-actions .btn-generate-large {
            flex: 1;
            min-width: unset;
            padding: 12px 20px;
        }

        .comercial-ai-panel .ai-results-grid {
            grid-template-columns: 1fr;
        }

        .comercial-ai-panel .ai-result-card {
            margin-top: 16px;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                height: calc(100vh - 80px);
                border-radius: 10px;
            }
            .comercial-ai-panel {
                width: 100vw;
            }
        }
    </style>

    <!-- Verificacao de autenticacao -->
    <script src="js/auth.js"></script>
</head>
<body>
    <div class="container">
        <!-- Menu Lateral -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Dashboards</h3>
                <button class="sidebar-close" onclick="toggleSidebar()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <ul class="sidebar-menu">
                <li class="sidebar-item">
                    <a href="index.html">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 20V10M12 20V4M6 20v-6"/>
                        </svg>
                        <span>Cancelamentos</span>
                    </a>
                </li>
                <li class="sidebar-item active">
                    <a href="comercial.html">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"/>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                        <span>Comercial</span>
                    </a>
                </li>
                <li class="sidebar-item disabled">
                    <a href="#">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        <span>CS</span>
                        <span class="badge-soon">Em breve</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="suporte.html">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        <span>Suporte</span>
                    </a>
                </li>
                <li class="sidebar-item sidebar-admin-only">
                    <a href="admin.html">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                        <span>Admin</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <header class="header">
            <div class="header-top">
                <button class="hamburger-btn" onclick="toggleSidebar()" title="Menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <h1 class="header-main-title">Dashboard Comercial</h1>
                <div class="header-controls">
                    <span class="user-display-name" id="userDisplayName"></span>
                    <button class="btn-icon-small btn-logout" onclick="hubstromLogout()" title="Sair">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Botão flutuante de IA -->
        <button class="comercial-ai-fab" onclick="toggleComercialAI()" id="btnComercialAIFab" title="Análise com IA">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
            </svg>
        </button>

        <!-- Painel de IA Comercial -->
        <div class="comercial-ai-panel" id="comercialAiPanel" style="display: none;">
            <div class="comercial-ai-panel-header">
                <h3>Análise com IA — Comercial</h3>
                <button class="modal-close" onclick="toggleComercialAI()">&times;</button>
            </div>
            <div class="comercial-ai-panel-body">
                <p class="comercial-ai-desc">Busque os dados da planilha comercial automaticamente. Atualize o GID quando mudar o mês.</p>

                <div class="comercial-gid-row">
                    <div class="comercial-gid-field">
                        <label for="comercialGidInput">GID da aba do mês</label>
                        <input type="text" id="comercialGidInput" placeholder="Ex: 1234622450" />
                    </div>
                    <button class="btn-fetch-sheets" onclick="fetchComercialData()" id="btnFetchComercial" title="Buscar dados da planilha">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.66 0 3-4.03 3-9s-1.34-9-3-9m0 18c-1.66 0-3-4.03-3-9s1.34-9 3-9"/>
                        </svg>
                        Buscar Dados
                    </button>
                </div>
                <span id="comercialFetchStatus" class="comercial-fetch-status"></span>

                <textarea id="comercialDataInput" class="comercial-ai-textarea" rows="6" placeholder="Os dados da planilha serão carregados aqui automaticamente. Ou cole dados manualmente." style="margin-top: 12px;"></textarea>
                <div class="comercial-ai-actions">
                    <button class="btn-generate-large" onclick="generateComercialAIAnalysis()" id="btnComercialAI">
                        <div class="btn-generate-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                                <path d="M2 17l10 5 10-5"/>
                                <path d="M2 12l10 5 10-5"/>
                            </svg>
                        </div>
                        <div class="btn-generate-text">
                            <span class="btn-generate-title">Gerar Análise</span>
                            <span class="btn-generate-subtitle">Insights, previsões e recomendações</span>
                        </div>
                    </button>
                    <button class="btn-config-ai" onclick="openComercialConfigModal()" title="Configurar API Key">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                    </button>
                    <span id="comercialApiStatus" class="api-status-indicator"></span>
                </div>
                <div id="comercialAiLoading" class="ai-loading" style="display: none;">
                    <div class="spinner"></div>
                    <span>Analisando dados comerciais com Claude AI...</span>
                </div>
                <!-- Resultados -->
                <div id="comercialAiResults" style="display: none;">
                    <div class="ai-results-grid">
                        <div class="ai-result-card">
                            <h3>Insights</h3>
                            <ul class="insight-list" id="comercialInsightsList"></ul>
                        </div>
                        <div class="ai-result-card">
                            <h3>Alertas e Previsões</h3>
                            <ul class="insight-list" id="comercialAlertsList"></ul>
                        </div>
                    </div>
                    <div class="ai-result-card" style="margin-top: 20px;">
                        <h3>Recomendações</h3>
                        <div id="comercialRecommendationsList" class="recommendations-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Config API Comercial -->
        <div id="comercialConfigModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Configuração da API</h3>
                    <button class="modal-close" onclick="closeComercialConfigModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <label for="comercialApiKeyInput">Chave da API Anthropic (Claude)</label>
                    <input type="password" id="comercialApiKeyInput" placeholder="sk-ant-api03-..." />
                    <p class="api-help">
                        Obtenha sua chave em: <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: #35cca3;">console.anthropic.com</a>
                    </p>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeComercialConfigModal()">Cancelar</button>
                    <button class="btn-primary" onclick="saveComercialApiKey()">Salvar</button>
                </div>
            </div>
        </div>

        <!-- Dashboard Container -->
        <div class="dashboard-container">
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
                <p>Carregando dashboard...</p>
            </div>
            <iframe
                id="lookerFrame"
                src="https://lookerstudio.google.com/embed/reporting/000b8c9f-c96a-4fae-954f-a04fc36b12d3"
                frameborder="0"
                allowfullscreen
                sandbox="allow-storage-access-by-user-activation allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox"
                onload="hideLoading()">
            </iframe>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <!-- Scripts -->
    <script>
        // Habilitar transições do sidebar após carregamento
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                document.getElementById('sidebar').classList.add('ready');
            }, 50);
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');

            if (sidebar.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        // Fechar sidebar com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('active')) {
                    toggleSidebar();
                }
            }
        });

        // Ocultar loading quando iframe carregar
        function hideLoading() {
            setTimeout(function() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.add('hidden');
                }
            }, 500);
        }

        // Timeout para esconder loading mesmo se o iframe demorar
        setTimeout(hideLoading, 5000);

        // ===================================
        // IA COMERCIAL
        // ===================================
        const COMERCIAL_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSSQ7mve2qz75gYNsmGqBj8yuyQO5JQU80qBcULnAYJ0MdYh373F0RD0DGc0Qpb5z7AjTdyyGyXQ1BP/pub';

        // Carregar GID salvo do Firebase
        document.addEventListener('firebaseReady', async function() {
            try {
                const savedGid = await getComercialGidFromFirebase();
                const gidInput = document.getElementById('comercialGidInput');
                if (gidInput) gidInput.value = savedGid || '1234622450';
            } catch (e) {
                const gidInput = document.getElementById('comercialGidInput');
                if (gidInput) gidInput.value = localStorage.getItem('comercial_gid') || '1234622450';
            }
        });

        async function fetchComercialData() {
            const gidInput = document.getElementById('comercialGidInput');
            const gid = gidInput ? gidInput.value.trim() : '';
            const statusEl = document.getElementById('comercialFetchStatus');
            const btn = document.getElementById('btnFetchComercial');

            if (!gid) {
                if (statusEl) { statusEl.textContent = 'Informe o GID da aba.'; statusEl.style.color = '#f87171'; }
                return;
            }

            // Salvar GID no Firebase
            if (typeof saveComercialGidToFirebase === 'function') {
                await saveComercialGidToFirebase(gid);
            }

            if (btn) { btn.disabled = true; btn.classList.add('loading'); }
            if (statusEl) { statusEl.textContent = 'Buscando dados...'; statusEl.style.color = '#94a3b8'; }

            try {
                const csvUrl = COMERCIAL_SHEET_URL + '?gid=' + gid + '&single=true&output=csv&_t=' + Date.now();
                const response = await fetch(csvUrl, { cache: 'no-store' });

                if (!response.ok) throw new Error('HTTP ' + response.status);

                const csvText = await response.text();
                const lines = csvText.split('\n').filter(function(l) { return l.trim(); });

                if (lines.length < 2) throw new Error('Planilha vazia ou sem dados.');

                // Formatar para o textarea de forma legível
                const headers = parseCSVLine(lines[0]);
                var formattedData = '';

                for (var i = 1; i < lines.length; i++) {
                    var values = parseCSVLine(lines[i]);
                    var row = [];
                    for (var j = 0; j < headers.length; j++) {
                        var h = (headers[j] || '').trim();
                        var v = (values[j] || '').trim();
                        if (h && v) row.push(h + ': ' + v);
                    }
                    if (row.length > 0) formattedData += row.join(' | ') + '\n';
                }

                var textarea = document.getElementById('comercialDataInput');
                if (textarea) textarea.value = formattedData.trim();

                if (statusEl) {
                    statusEl.textContent = (lines.length - 1) + ' registros carregados.';
                    statusEl.style.color = '#35cca3';
                }

            } catch (error) {
                console.error('Erro ao buscar planilha comercial:', error);
                if (statusEl) {
                    statusEl.textContent = 'Erro: ' + error.message;
                    statusEl.style.color = '#f87171';
                }
            } finally {
                if (btn) { btn.disabled = false; btn.classList.remove('loading'); }
            }
        }

        function parseCSVLine(line) {
            var result = [];
            var current = '';
            var inQuotes = false;
            for (var i = 0; i < line.length; i++) {
                var ch = line[i];
                if (ch === '"') {
                    if (inQuotes && line[i + 1] === '"') { current += '"'; i++; }
                    else inQuotes = !inQuotes;
                } else if (ch === ',' && !inQuotes) {
                    result.push(current); current = '';
                } else {
                    current += ch;
                }
            }
            result.push(current);
            return result;
        }
        function getComercialApiKey() {
            return localStorage.getItem('anthropic_api_key') || '';
        }

        function hasComercialApiKey() {
            const key = getComercialApiKey();
            return key && key.startsWith('sk-ant-');
        }

        function updateComercialApiStatus() {
            const el = document.getElementById('comercialApiStatus');
            if (el) {
                if (hasComercialApiKey()) {
                    el.textContent = '\u2713 API Key configurada';
                    el.style.color = '#35cca3';
                } else {
                    el.textContent = '\u2717 API Key não configurada';
                    el.style.color = '#f87171';
                }
            }
        }

        function toggleComercialAI() {
            const panel = document.getElementById('comercialAiPanel');
            const fab = document.getElementById('btnComercialAIFab');
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
                fab.classList.add('active');
                updateComercialApiStatus();
            } else {
                panel.style.display = 'none';
                fab.classList.remove('active');
            }
        }

        function openComercialConfigModal() {
            const modal = document.getElementById('comercialConfigModal');
            const input = document.getElementById('comercialApiKeyInput');
            if (modal) {
                modal.style.display = 'flex';
                if (input) input.value = getComercialApiKey();
            }
        }

        function closeComercialConfigModal() {
            const modal = document.getElementById('comercialConfigModal');
            if (modal) modal.style.display = 'none';
        }

        function saveComercialApiKey() {
            const input = document.getElementById('comercialApiKeyInput');
            if (!input) return;
            const key = input.value.trim();
            if (!key.startsWith('sk-ant-')) {
                alert('Chave inválida. A chave deve começar com "sk-ant-"');
                return;
            }
            localStorage.setItem('anthropic_api_key', key);
            closeComercialConfigModal();
            updateComercialApiStatus();
        }

        async function generateComercialAIAnalysis() {
            var dataInput = document.getElementById('comercialDataInput');
            var rawData = dataInput ? dataInput.value.trim() : '';

            // Se não tem dados, tentar buscar automaticamente
            if (!rawData) {
                await fetchComercialData();
                rawData = dataInput ? dataInput.value.trim() : '';
                if (!rawData) {
                    alert('Nenhum dado encontrado. Verifique o GID da aba.');
                    return;
                }
            }

            if (!hasComercialApiKey()) {
                openComercialConfigModal();
                return;
            }

            const btn = document.getElementById('btnComercialAI');
            const loading = document.getElementById('comercialAiLoading');
            const results = document.getElementById('comercialAiResults');

            if (btn) btn.disabled = true;
            if (loading) loading.style.display = 'flex';
            if (results) results.style.display = 'none';

            try {
                const prompt = buildComercialPrompt(rawData);

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': getComercialApiKey(),
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-haiku-20240307',
                        max_tokens: 3000,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Erro na API');
                }

                const result = await response.json();
                const content = result.content[0].text;
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('Resposta inválida da IA');
                const analysis = JSON.parse(jsonMatch[0]);

                renderComercialInsights(analysis.insights || []);
                renderComercialAlerts(analysis.alertas || []);
                renderComercialRecommendations(analysis.recommendations || []);

                if (results) results.style.display = 'block';

            } catch (error) {
                console.error('Erro na análise IA comercial:', error);
                alert('Erro ao gerar análise: ' + error.message);
            } finally {
                if (btn) btn.disabled = false;
                if (loading) loading.style.display = 'none';
            }
        }

        function buildComercialPrompt(rawData) {
            return `Você é um analista comercial especializado em performance de vendas de SaaS B2B.

Analise os seguintes dados comerciais e gere insights, alertas/previsões e recomendações de ações.

## DADOS COMERCIAIS DO PERÍODO:

${rawData}

## INSTRUÇÕES:

Gere uma análise em formato JSON com a seguinte estrutura:

{
  "insights": [
    {
      "tipo": "critico|alerta|positivo",
      "titulo": "Título curto e impactante",
      "descricao": "Descrição detalhada do insight baseado nos dados"
    }
  ],
  "alertas": [
    {
      "nivel": "alto|medio|baixo",
      "titulo": "Alerta ou previsão",
      "descricao": "Detalhe do alerta, tendência ou previsão"
    }
  ],
  "recommendations": [
    {
      "prioridade": 1,
      "titulo": "Título da recomendação",
      "descricao": "Descrição da ação recomendada",
      "impacto": "Impacto esperado"
    }
  ]
}

IMPORTANTE:
- Gere 4-6 insights sobre a performance comercial (conversão, ticket médio, comparativo entre vendedores, meta)
- Gere 3-5 alertas ou previsões (tendências, riscos, gargalos no funil, desistências, pendentes)
- Gere 4-5 recomendações práticas ordenadas por prioridade (ações para cada vendedor, estratégias de fechamento, gestão de pipeline)
- Baseie-se APENAS nos dados fornecidos
- Seja específico com números e porcentagens
- Compare performance entre especialistas
- Analise taxa de conversão, desistentes e pendentes
- Projete tendências se possível

Responda APENAS com o JSON, sem texto adicional.`;
        }

        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function renderComercialInsights(insights) {
            const el = document.getElementById('comercialInsightsList');
            if (!el) return;
            const icons = { critico: '\uD83D\uDD34', alerta: '\uD83D\uDFE1', positivo: '\uD83D\uDFE2' };
            el.innerHTML = insights.map(i =>
                '<li><strong>' + (icons[i.tipo] || '\uD83D\uDD35') + ' ' + escapeHTML(i.titulo) + ':</strong> ' + escapeHTML(i.descricao) + '</li>'
            ).join('');
        }

        function renderComercialAlerts(alerts) {
            const el = document.getElementById('comercialAlertsList');
            if (!el) return;
            const icons = { alto: '\uD83D\uDD34', medio: '\uD83D\uDFE1', baixo: '\uD83D\uDFE2' };
            el.innerHTML = alerts.map(a =>
                '<li><strong>' + (icons[a.nivel] || '\uD83D\uDFE1') + ' ' + escapeHTML(a.titulo) + ':</strong> ' + escapeHTML(a.descricao) + '</li>'
            ).join('');
        }

        function renderComercialRecommendations(recs) {
            const el = document.getElementById('comercialRecommendationsList');
            if (!el) return;
            el.innerHTML = recs.map(function(rec, i) {
                return '<article class="recommendation-card"><h4>' + (i + 1) + '. ' + escapeHTML(rec.titulo) + '</h4><p>' + escapeHTML(rec.descricao) + '</p>' +
                    (rec.impacto ? '<p style="color: #35cca3; font-size: 0.9em; margin-top: 10px;"><strong>Impacto esperado:</strong> ' + escapeHTML(rec.impacto) + '</p>' : '') +
                    '</article>';
            }).join('');
        }

        // Inicializar status
        document.addEventListener('DOMContentLoaded', updateComercialApiStatus);
    </script>
</body>
</html>
