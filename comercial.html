<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard Comercial - Métricas e Performance">
    <title>Hubstrom - Comercial</title>

    <!-- Favicon Hubstrom -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Cpath d='M161 85c2.7-1.2 5.6.8 5.6 3.7v50.3c0 1.6-.9 3-2.4 3.7L35.2 199.9c-.9.4-1.9-.3-1.9-1.2v-54.4c0-1.6.9-3 2.4-3.7L161 85z' fill='%2335CCA3'/%3E%3Cpath d='M164.8.1c.9-.4 1.9.3 1.9 1.2v54.4c0 1.6-.9 3-2.4 3.7L39 114.9c-2.7 1.2-5.6-.8-5.6-3.7V61c0-1.6.9-3 2.4-3.7L164.8.1z' fill='%2335CCA3'/%3E%3C/svg%3E">

    <!-- Fonte Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Estilos -->
    <link rel="stylesheet" href="css/styles.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <!-- Verificacao de autenticacao -->
    <script src="js/auth.js"></script>

    <style>
        /* ======================== IDENTIDADE VISUAL HUBSTROM ======================== */
        .container, .dash-grid, .dash-card, .ranking-item, .kpi-card, .today-card, .header {
            font-family: 'Poppins', sans-serif;
        }

        /* ======================== HEADER ======================== */
        .header {
            margin-bottom: 0;
        }

        /* ======================== DASHBOARD GRID ======================== */
        .dash-grid {
            display: grid;
            grid-template-columns: 38% 1fr;
            grid-template-rows: 1fr;
            gap: 1vh 1vw;
            padding: 1vh 1.5vw 1.2vh;
            height: calc(100vh - clamp(50px, 6vh, 100px));
            overflow: hidden;
            box-sizing: border-box;
        }

        /* Coluna esquerda: ranking + contratados hoje */
        .dash-left {
            display: flex;
            flex-direction: column;
            gap: 1.2vh;
            overflow: hidden;
            min-height: 0;
        }

        /* Coluna direita: chart + KPIs */
        .dash-right {
            display: flex;
            flex-direction: column;
            gap: 1.2vh;
            overflow: hidden;
            min-height: 0;
        }

        /* ======================== CARDS BASE ======================== */
        .dash-card {
            background: linear-gradient(145deg, #151922, #0F172A);
            border: 1px solid rgba(53, 204, 163, 0.08);
            border-radius: clamp(10px, 1.2vw, 20px);
            padding: clamp(10px, 1.5vh, 24px) clamp(10px, 1.2vw, 24px);
        }

        .dash-card-title {
            display: flex;
            align-items: center;
            gap: clamp(6px, 0.6vw, 12px);
            color: #e7e7e7;
            font-size: clamp(0.75em, 1vw, 1.15em);
            font-weight: 600;
            margin-bottom: clamp(6px, 1vh, 16px);
        }

        .dash-card-title svg {
            color: #35CCA3;
            flex-shrink: 0;
        }

        /* ======================== RANKING CLOSERS ======================== */
        .ranking-card {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .ranking-header {
            display: grid;
            grid-template-columns: clamp(32px, 3vw, 50px) 1fr auto auto;
            padding: 0 clamp(8px, 1vw, 18px) clamp(6px, 0.8vh, 12px);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            margin-bottom: clamp(4px, 0.6vh, 10px);
        }

        .ranking-header span {
            font-size: clamp(0.6em, 0.7vw, 0.85em);
            color: #8c95a3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .ranking-header span:nth-child(3),
        .ranking-header span:nth-child(4) {
            text-align: center;
            min-width: clamp(80px, 8vw, 140px);
        }

        .ranking-item {
            display: grid;
            grid-template-columns: clamp(32px, 3vw, 50px) 1fr auto auto;
            align-items: center;
            padding: clamp(8px, 1.2vh, 18px) clamp(8px, 1vw, 18px);
            border-radius: clamp(10px, 1vw, 16px);
            transition: background 0.2s;
            border: 1px solid transparent;
            margin-bottom: clamp(2px, 0.4vh, 6px);
        }

        .ranking-item:hover {
            background: rgba(53, 204, 163, 0.04);
        }

        /* Ouro - 1o lugar */
        .ranking-item.rank-1 {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.10), rgba(255, 215, 0, 0.02));
            border-color: rgba(255, 215, 0, 0.25);
        }
        /* Prata - 2o lugar */
        .ranking-item.rank-2 {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.08), rgba(192, 192, 192, 0.02));
            border-color: rgba(192, 192, 192, 0.15);
        }
        /* Bronze - 3o lugar */
        .ranking-item.rank-3 {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.08), rgba(205, 127, 50, 0.02));
            border-color: rgba(205, 127, 50, 0.15);
        }

        .rank-pos {
            width: clamp(28px, 2.8vw, 46px);
            height: clamp(28px, 2.8vw, 46px);
            border-radius: clamp(8px, 0.7vw, 12px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: clamp(0.8em, 0.95vw, 1.2em);
            color: #e7e7e7;
            background: rgba(255,255,255,0.05);
        }

        .rank-1 .rank-pos { background: linear-gradient(135deg, #FFD700, #DAA520); color: #151922; box-shadow: 0 0 14px rgba(255, 215, 0, 0.35); }
        .rank-2 .rank-pos { background: linear-gradient(135deg, #C0C0C0, #A8A8A8); color: #151922; box-shadow: 0 0 12px rgba(192, 192, 192, 0.25); }
        .rank-3 .rank-pos { background: linear-gradient(135deg, #CD7F32, #B8702E); color: #151922; box-shadow: 0 0 12px rgba(205, 127, 50, 0.25); }

        .rank-info {
            display: flex;
            align-items: center;
            gap: clamp(10px, 1vw, 18px);
            padding-left: clamp(8px, 0.8vw, 16px);
        }

        .rank-avatar {
            width: clamp(44px, 4.5vw, 68px);
            height: clamp(44px, 4.5vw, 68px);
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.12);
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .rank-1 .rank-avatar { border-color: #ffd700; box-shadow: 0 0 14px rgba(255, 215, 0, 0.25); }
        .rank-2 .rank-avatar { border-color: #C0C0C0; box-shadow: 0 0 12px rgba(192, 192, 192, 0.2); }
        .rank-3 .rank-avatar { border-color: #CD7F32; box-shadow: 0 0 12px rgba(205, 127, 50, 0.2); }

        .rank-name {
            font-weight: 600;
            color: #e7e7e7;
            font-size: clamp(0.85em, 1vw, 1.2em);
        }

        .rank-pending {
            font-size: clamp(0.6em, 0.65vw, 0.82em);
            color: #E8BB34;
            margin-top: 2px;
        }

        .rank-pending.empty { color: #8c95a3; }

        .rank-sales-col {
            text-align: center;
            min-width: clamp(80px, 8vw, 140px);
        }

        .rank-sales {
            font-weight: 800;
            color: #35CCA3;
            font-size: clamp(0.88em, 1vw, 1.2em);
            text-shadow: 0 0 12px rgba(53, 204, 163, 0.25);
        }

        .rank-sales-pending {
            font-size: clamp(0.55em, 0.6vw, 0.75em);
            color: #E8BB34;
            margin-top: 2px;
        }

        .rank-conversion {
            text-align: center;
            font-weight: 700;
            color: #e7e7e7;
            font-size: clamp(0.82em, 0.95vw, 1.15em);
            min-width: clamp(80px, 8vw, 140px);
        }

        /* ======================== CONTRATADOS HOJE ======================== */
        .today-card {
            flex: 0 0 auto;
            background: linear-gradient(145deg, #0F2A23, #0F172A);
            border-color: rgba(53, 204, 163, 0.15);
            padding: clamp(12px, 1.8vh, 28px) clamp(10px, 1.5vw, 24px);
        }

        .today-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: clamp(8px, 1.2vh, 20px);
        }

        .today-value {
            font-size: clamp(1.4em, 2.2vw, 3.4em);
            font-weight: 800;
            color: #35CCA3;
        }

        .today-last-sale {
            background: rgba(255,255,255,0.04);
            border-radius: clamp(8px, 1vw, 14px);
            padding: clamp(8px, 1vh, 16px) clamp(10px, 1.2vw, 20px);
            display: flex;
            align-items: center;
            gap: clamp(8px, 1vw, 14px);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        /* Neon border rodando continuamente */
        .today-last-sale::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: conic-gradient(
                from var(--neon-angle, 0deg),
                transparent 0%,
                #35CCA3 10%,
                #68C9AE 20%,
                transparent 30%,
                transparent 50%,
                #E8BB34 60%,
                #35CCA3 70%,
                transparent 80%
            );
            border-radius: inherit;
            z-index: -2;
            animation: neonSpin 3s linear infinite;
        }

        .today-last-sale::after {
            content: '';
            position: absolute;
            top: 2px; left: 2px; right: 2px; bottom: 2px;
            background: linear-gradient(145deg, #0F2A23, #0F172A);
            border-radius: clamp(6px, 0.8vw, 12px);
            z-index: -1;
        }

        @property --neon-angle {
            syntax: '<angle>';
            initial-value: 0deg;
            inherits: false;
        }

        @keyframes neonSpin {
            to { --neon-angle: 360deg; }
        }

        .today-last-sale-badge {
            font-size: clamp(0.6em, 0.7vw, 0.85em);
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #68C9AE;
            font-weight: 600;
        }

        .today-last-sale-info {
            flex: 1;
        }

        .today-last-sale-closer {
            font-weight: 600;
            color: #e7e7e7;
            font-size: clamp(0.8em, 0.9vw, 1.15em);
        }

        .today-last-sale-closer .elite {
            color: #68C9AE;
            font-size: 0.85em;
            margin-left: 4px;
        }

        .today-last-sale-value {
            color: #35CCA3;
            font-weight: 700;
            font-size: clamp(0.8em, 0.85vw, 1.1em);
            margin-top: 2px;
        }

        .today-last-sale-avatar {
            width: clamp(36px, 3.8vw, 60px);
            height: clamp(36px, 3.8vw, 60px);
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(53, 204, 163, 0.4);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .today-progress {
            margin-top: clamp(8px, 1.2vh, 20px);
        }

        .today-progress-bar {
            height: clamp(6px, 1vh, 14px);
            background: rgba(255,255,255,0.06);
            border-radius: 8px;
            overflow: hidden;
        }

        .today-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #35CCA3, #2FB490);
            border-radius: 8px;
            transition: width 1s ease;
        }

        .today-progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: clamp(4px, 0.6vh, 10px);
            font-size: clamp(0.72em, 0.8vw, 1em);
        }

        .today-progress-current { color: #35CCA3; font-weight: 700; }
        .today-progress-meta { color: #8c95a3; }

        /* ======================== CHART ======================== */
        .chart-card {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .chart-card .chart-wrapper {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        /* ======================== KPIs GRID BOTTOM ======================== */
        .kpis-bottom {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: clamp(8px, 1vw, 16px);
        }

        .kpis-bottom-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: clamp(8px, 1vw, 16px);
        }

        .kpi-card {
            background: linear-gradient(145deg, #151922, #0F172A);
            border: 1px solid rgba(53, 204, 163, 0.08);
            border-radius: clamp(10px, 1.2vw, 20px);
            padding: clamp(10px, 1.2vh, 20px) clamp(10px, 1vw, 20px);
            display: flex;
            align-items: center;
            gap: clamp(8px, 1vw, 16px);
        }

        .kpi-icon {
            width: clamp(32px, 3.5vw, 56px);
            height: clamp(32px, 3.5vw, 56px);
            border-radius: clamp(8px, 0.8vw, 14px);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .kpi-icon.green { background: rgba(53, 204, 163, 0.15); color: #35CCA3; }
        .kpi-icon.blue { background: rgba(22, 150, 179, 0.15); color: #1696B3; }
        .kpi-icon.yellow { background: rgba(232, 187, 52, 0.15); color: #E8BB34; }
        .kpi-icon.purple { background: rgba(13, 171, 206, 0.15); color: #0DABCE; }

        .kpi-data { text-align: left; flex: 1; }
        .kpi-label { font-size: clamp(0.6em, 0.7vw, 0.88em); color: #8c95a3; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; margin-bottom: 2px; }
        .kpi-value { font-size: clamp(1em, 1.2vw, 1.8em); font-weight: 700; color: #e7e7e7; }
        .kpi-value.accent { color: #35CCA3; }

        /* ======================== CONTRATOS DO MES ======================== */
        .contratos-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: clamp(8px, 1vw, 16px);
        }

        .contrato-item {
            text-align: center;
            padding: clamp(8px, 1vh, 16px);
            background: rgba(255,255,255,0.02);
            border-radius: clamp(8px, 0.8vw, 14px);
            border: 1px solid rgba(255,255,255,0.04);
        }

        .contrato-label {
            font-size: clamp(0.6em, 0.65vw, 0.85em);
            color: #8c95a3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: clamp(4px, 0.5vh, 8px);
        }

        .contrato-value {
            font-size: clamp(1.4em, 1.8vw, 3em);
            font-weight: 800;
            color: #e7e7e7;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: clamp(6px, 0.6vw, 10px);
        }

        .contrato-value svg { color: #35CCA3; }
        .contrato-value.pending svg { color: #E8BB34; }

        .contratos-vendas-total {
            display: flex;
            align-items: center;
            gap: clamp(8px, 0.8vw, 14px);
            margin-top: clamp(8px, 1vh, 14px);
            padding: clamp(8px, 1vh, 14px) clamp(10px, 1vw, 18px);
            background: rgba(53, 204, 163, 0.06);
            border-radius: clamp(8px, 0.8vw, 14px);
            border: 1px solid rgba(53, 204, 163, 0.12);
        }

        .contratos-vendas-data {
            flex: 1;
            text-align: center;
        }

        .contratos-vendas-label {
            font-size: clamp(0.6em, 0.65vw, 0.85em);
            color: #8c95a3;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .contratos-vendas-value {
            font-size: clamp(1.2em, 1.5vw, 2.2em);
            font-weight: 800;
            color: #35CCA3;
        }

        /* ======================== LOADING ======================== */
        .dash-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: calc(100vh - 60px);
        }

        .dash-loading .spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(53, 204, 163, 0.2);
            border-top-color: #35CCA3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .dash-loading p { margin-top: 20px; color: #B9C0CA; font-size: 1rem; }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ======================== SYNC INDICATOR ======================== */
        .sync-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.72em;
            color: #475569;
            margin-left: auto;
        }

        .sync-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: #35CCA3;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ======================== ANIMACAO NOVA VENDA ======================== */
        @keyframes cashIn {
            0% { transform: scale(1); text-shadow: 0 0 0 transparent; }
            10% { transform: scale(1.3); text-shadow: 0 0 40px rgba(53, 204, 163, 0.8); }
            25% { transform: scale(1.05); }
            40% { transform: scale(1.2); text-shadow: 0 0 25px rgba(53, 204, 163, 0.5); }
            100% { transform: scale(1); text-shadow: 0 0 0 transparent; }
        }

        @keyframes flashCard {
            0% { box-shadow: inset 0 0 0 rgba(53, 204, 163, 0); border-color: rgba(53, 204, 163, 0.15); }
            15% { box-shadow: inset 0 0 60px rgba(53, 204, 163, 0.12), 0 0 50px rgba(53, 204, 163, 0.25); border-color: rgba(53, 204, 163, 0.5); }
            100% { box-shadow: inset 0 0 0 rgba(53, 204, 163, 0); border-color: rgba(53, 204, 163, 0.15); }
        }

        @keyframes confettiFall {
            0% { opacity: 1; transform: translateY(0) rotate(0deg) scale(1); }
            100% { opacity: 0; transform: translateY(calc(100vh - 100px)) rotate(720deg) scale(0.5); }
        }

        @keyframes moneyRain {
            0% { opacity: 1; transform: translateY(-20px) scale(1.2); }
            50% { opacity: 1; }
            100% { opacity: 0; transform: translateY(80px) scale(0.6); }
        }

        .today-card.cash-animation {
            animation: flashCard 2s ease-out;
        }

        .today-value.cash-animation {
            animation: cashIn 1.5s ease-out;
        }

        .confetti-piece {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 999;
            animation: confettiFall linear forwards;
        }

        .money-rain {
            position: absolute;
            pointer-events: none;
            z-index: 10;
            font-size: clamp(1.5em, 2.5vw, 3em);
            animation: moneyRain 2.5s ease-out forwards;
        }

        /* ======================== FAB + PANEL IA ======================== */
        .comercial-ai-fab {
            position: fixed; bottom: 24px; right: 24px;
            width: 56px; height: 56px; border-radius: 50%;
            background: linear-gradient(135deg, #35CCA3, #2FB490);
            border: none; color: #0F172A; cursor: pointer;
            z-index: 200; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 6px 24px rgba(53, 204, 163, 0.4);
            transition: all 0.3s ease;
        }
        .comercial-ai-fab:hover { transform: scale(1.1); box-shadow: 0 8px 32px rgba(53, 204, 163, 0.6); }
        .comercial-ai-fab.active { background: linear-gradient(135deg, #e05d5d, #dc2626); box-shadow: 0 6px 24px rgba(224, 93, 93, 0.4); }
        .comercial-ai-fab.active svg { transform: rotate(45deg); }

        .comercial-ai-panel {
            position: fixed; top: 0; right: 0;
            width: 520px; max-width: 100vw; height: 100vh;
            background: #0F172A; border-left: 1px solid rgba(53, 204, 163, 0.2);
            z-index: 300; display: flex; flex-direction: column;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.5);
            animation: slideInRight 0.3s ease;
        }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .comercial-ai-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .comercial-ai-panel-header h3 { color: #35CCA3; font-size: 1.1em; }
        .comercial-ai-panel-body { flex: 1; overflow-y: auto; padding: 20px; }
        .comercial-fetch-status { font-size: 0.82em; min-height: 1.2em; }

        /* Status RT */
        .ai-rt-status {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 14px; border-radius: 10px; margin-bottom: 20px;
            background: rgba(53,204,163,0.06); border: 1px solid rgba(53,204,163,0.15);
        }
        .ai-rt-status .rt-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #35CCA3;
            animation: rtPulse 2s ease-in-out infinite;
        }
        .ai-rt-status.waiting .rt-dot { background: #6B7280; animation: none; }
        @keyframes rtPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Campo de pergunta */
        .ai-question-wrap { margin-bottom: 20px; }
        .ai-question-wrap label {
            display: block; font-size: 0.8em; color: #6B7280;
            text-transform: uppercase; letter-spacing: 0.5px;
            margin-bottom: 8px; font-weight: 600;
        }
        .ai-question-input {
            width: 100%; padding: 12px 14px;
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px; color: #E7E7E7; font-size: 0.92em;
            resize: none; transition: border-color 0.2s;
            font-family: inherit;
        }
        .ai-question-input:focus {
            outline: none; border-color: rgba(53,204,163,0.4);
            background: rgba(255,255,255,0.06);
        }
        .ai-question-input::placeholder { color: #4B5563; }

        /* Botoes de acao */
        .ai-action-buttons { display: flex; gap: 10px; margin-bottom: 16px; }
        .ai-btn {
            flex: 1; display: flex; align-items: center; gap: 12px;
            padding: 14px 16px; border-radius: 12px; cursor: pointer;
            border: 1px solid transparent; transition: all 0.2s ease;
        }
        .ai-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .ai-btn-icon {
            width: 40px; height: 40px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .ai-btn-text { display: flex; flex-direction: column; gap: 2px; text-align: left; }
        .ai-btn-title { font-size: 0.9em; font-weight: 600; }
        .ai-btn-sub { font-size: 0.75em; opacity: 0.7; }

        .ai-btn-resumo {
            background: linear-gradient(135deg, rgba(53,204,163,0.12), rgba(53,204,163,0.04));
            border-color: rgba(53,204,163,0.25); color: #E7E7E7;
        }
        .ai-btn-resumo:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(53,204,163,0.2), rgba(53,204,163,0.08));
            border-color: rgba(53,204,163,0.4);
        }
        .ai-btn-resumo .ai-btn-icon { background: rgba(53,204,163,0.15); color: #35CCA3; }

        .ai-btn-pergunta {
            background: rgba(99,102,241,0.08);
            border-color: rgba(99,102,241,0.2); color: #E7E7E7;
        }
        .ai-btn-pergunta:hover:not(:disabled) {
            background: rgba(99,102,241,0.14);
            border-color: rgba(99,102,241,0.35);
        }
        .ai-btn-pergunta .ai-btn-icon { background: rgba(99,102,241,0.15); color: #818CF8; }

        /* Barra inferior (config + GID) */
        .ai-bottom-bar {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 0; margin-bottom: 16px;
            border-top: 1px solid rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .ai-config-btn {
            width: 34px; height: 34px; border-radius: 8px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08);
            color: #9CA3AF; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .ai-config-btn:hover { background: rgba(255,255,255,0.1); color: #E7E7E7; }
        .ai-api-status { font-size: 0.8em; }
        .ai-gid-toggle {
            margin-left: auto; color: #4B5563; font-size: 0.78em; cursor: pointer;
            user-select: none;
        }
        .ai-gid-toggle summary { list-style: none; display: flex; align-items: center; gap: 4px; }
        .ai-gid-toggle summary::-webkit-details-marker { display: none; }
        .ai-gid-row {
            display: flex; gap: 6px; margin-top: 8px; align-items: center;
            padding: 8px 10px; background: rgba(255,255,255,0.03); border-radius: 8px;
        }
        .ai-gid-input {
            width: 130px; padding: 6px 10px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px; color: #E7E7E7; font-size: 0.82em;
        }
        .ai-gid-btn {
            padding: 6px 12px; background: rgba(53,204,163,0.1);
            border: 1px solid rgba(53,204,163,0.2); border-radius: 6px;
            color: #35CCA3; font-size: 0.8em; cursor: pointer; transition: all 0.2s;
        }
        .ai-gid-btn:hover { background: rgba(53,204,163,0.2); }

        /* ======================== RESPONSIVE ======================== */

        /* Tablet portrait e menor (< 1024px) - layout single column com scroll */
        @media (max-width: 1023px) {
            .dash-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                height: auto;
                overflow-y: auto;
                overflow-x: hidden;
                gap: 14px;
                padding: 14px 16px 16px;
            }
            .dash-left, .dash-right { overflow: visible; }
            .ranking-card { max-height: none; flex: none; }
            .chart-card .chart-wrapper { min-height: 320px; }
        }

        /* Mobile landscape (< 768px) */
        @media (max-width: 767px) {
            .dash-grid { padding: 10px 12px 14px; gap: 12px; }
            .dash-card { padding: 16px; border-radius: 14px; }
            .today-top { flex-direction: column; gap: 14px; align-items: stretch; }
            .kpis-bottom-row { grid-template-columns: 1fr; }
            .chart-card .chart-wrapper { min-height: 280px; }
            .comercial-ai-panel { width: 100vw; }
            .comercial-ai-fab { bottom: 16px; right: 16px; width: 48px; height: 48px; }
        }

        /* Mobile portrait (< 480px) */
        @media (max-width: 480px) {
            .dash-grid { padding: 8px 8px 12px; gap: 10px; }
            .dash-card { padding: 14px 12px; border-radius: 12px; }
            .dash-card-title { font-size: 0.92em; gap: 8px; margin-bottom: 12px; }
            .chart-card .chart-wrapper { min-height: 240px; }
            .comercial-ai-fab { bottom: 12px; right: 12px; width: 44px; height: 44px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Menu Lateral -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Dashboards</h3>
                <button class="sidebar-close" onclick="toggleSidebar()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <ul class="sidebar-menu">
                <li class="sidebar-item">
                    <a href="index.html">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 20V10M12 20V4M6 20v-6"/>
                        </svg>
                        <span>Cancelamentos</span>
                    </a>
                </li>
                <li class="sidebar-item active">
                    <a href="comercial.html">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"/>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                        <span>Comercial</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="analise-comercial.html">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                        </svg>
                        <span>Análise Comercial</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="relacionamento.html">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        <span>Relacionamento</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="suporte.html">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        <span>Suporte</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="log-erros.html">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <span>Log de Erros</span>
                    </a>
                </li>
                <li class="sidebar-item sidebar-admin-only">
                    <a href="admin.html">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                        <span>Admin</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <header class="header">
            <div class="header-top">
                <button class="hamburger-btn" onclick="toggleSidebar()" title="Menu">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <h1 class="header-main-title">Dashboard Comercial</h1>
                <div class="header-controls">
                    <select id="comercialMonthFilter" class="month-selector" onchange="handleComercialMonthChange(this.value)">
                        <option value="live">Mês atual (ao vivo)</option>
                    </select>
                    <button class="btn-icon-small btn-sync-sheets" id="btnRefreshDash" onclick="loadDashboardData()" title="Sincronizar com Google Sheets">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.66 0 3-4.03 3-9s-1.34-9-3-9m0 18c-1.66 0-3-4.03-3-9s1.34-9 3-9"/>
                        </svg>
                    </button>
                    <span class="user-display-name" id="userDisplayName"></span>
                    <button class="btn-icon-small btn-logout" onclick="hubstromLogout()" title="Sair">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Loading -->
        <div class="dash-loading" id="dashLoading">
            <div class="spinner"></div>
            <p>Carregando dados comerciais...</p>
        </div>

        <!-- Dashboard Grid -->
        <div class="dash-grid" id="dashGrid" style="display: none;">
            <!-- ======= COLUNA ESQUERDA ======= -->
            <div class="dash-left">
                <!-- Ranking de Closers -->
                <div class="dash-card ranking-card">
                    <div class="dash-card-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        Ranking Especialistas
                        <div class="sync-info"><div class="sync-dot"></div>Sincronizado</div>
                    </div>
                    <div class="ranking-header">
                        <span>#</span>
                        <span>Especialista</span>
                        <span>Vendas</span>
                        <span>Conversão %</span>
                    </div>
                    <div id="rankingList"></div>
                </div>

                <!-- Contratados Hoje -->
                <div class="dash-card today-card">
                    <div class="today-top">
                        <div>
                            <div style="font-size:clamp(0.65em,0.75vw,0.95em);color:#64748b;text-transform:uppercase;letter-spacing:1px;margin-bottom:clamp(4px,0.6vh,8px);font-weight:600;">Contratados hoje</div>
                            <div class="today-value" id="todayValue">R$ 0,00</div>
                        </div>
                        <div class="today-last-sale" id="todayLastSale">
                            <div class="today-last-sale-info">
                                <div class="today-last-sale-badge">Venda concretizada!</div>
                                <div class="today-last-sale-closer" id="lastSaleCloser">-</div>
                                <div class="today-last-sale-value" id="lastSaleValue">-</div>
                            </div>
                            <img class="today-last-sale-avatar" id="lastSaleAvatar" src="" alt="" style="display:none">
                        </div>
                    </div>
                    <div class="today-progress">
                        <div class="today-progress-bar">
                            <div class="today-progress-fill" id="todayProgressFill" style="width:0%"></div>
                        </div>
                        <div class="today-progress-labels">
                            <span class="today-progress-current" id="todayProgressCurrent">R$ 0,00</span>
                            <span class="today-progress-meta">/ <span id="todayProgressMeta">R$ 0,00</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ======= COLUNA DIREITA ======= -->
            <div class="dash-right">
                <!-- Gráfico de Barras -->
                <div class="dash-card chart-card">
                    <div class="dash-card-title">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="14"/>
                        </svg>
                        Panorama do Mês
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="kpiChart"></canvas>
                    </div>
                </div>

                <!-- Cards KPIs -->
                <div class="kpis-bottom-row">
                    <!-- Contratos do mês + Vendas do mês -->
                    <div class="dash-card">
                        <div class="dash-card-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            Contratos do mês
                        </div>
                        <div class="contratos-grid">
                            <div class="contrato-item">
                                <div class="contrato-label">Pagos</div>
                                <div class="contrato-value" id="contratosPagos">
                                    <span>0</span>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#35CCA3" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                                </div>
                            </div>
                            <div class="contrato-item">
                                <div class="contrato-label">Pendentes</div>
                                <div class="contrato-value pending" id="contratosPendentes">
                                    <span>0</span>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                </div>
                            </div>
                        </div>
                        <div class="contratos-vendas-total">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#35CCA3" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            <div class="contratos-vendas-data">
                                <div class="contratos-vendas-label">Vendas do mês (total)</div>
                                <div class="contratos-vendas-value" id="kpiVendasTotal">R$ 0,00</div>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs direita -->
                    <div style="display:flex;flex-direction:column;gap:clamp(8px, 1vh, 16px);">
                        <div class="kpi-card">
                            <div class="kpi-icon yellow">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                                </svg>
                            </div>
                            <div class="kpi-data">
                                <div class="kpi-label">Contratos gerados</div>
                                <div class="kpi-value" id="kpiGerados">R$ 0,00</div>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-icon blue">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                                </svg>
                            </div>
                            <div class="kpi-data">
                                <div class="kpi-label">Taxa de conversão</div>
                                <div class="kpi-value" id="kpiTaxaConversao">0%</div>
                            </div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-icon purple">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                            </div>
                            <div class="kpi-data">
                                <div class="kpi-label">Meta semanal</div>
                                <div class="kpi-value" id="kpiMetaSemanal">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botão flutuante de IA -->
    <button class="comercial-ai-fab" onclick="toggleComercialAI()" id="btnComercialAIFab" title="Análise com IA">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
        </svg>
    </button>

    <!-- Painel de IA Comercial -->
    <div class="comercial-ai-panel" id="comercialAiPanel" style="display: none;">
        <div class="comercial-ai-panel-header">
            <h3>IA Comercial</h3>
            <button class="modal-close" onclick="toggleComercialAI()">&times;</button>
        </div>
        <div class="comercial-ai-panel-body">
            <!-- Status dos dados em tempo real -->
            <div class="ai-rt-status" id="comercialDataStatus">
                <span class="rt-dot"></span>
                <span id="comercialDataStatusText">Carregando dados em tempo real...</span>
            </div>

            <!-- Pergunta personalizada -->
            <div class="ai-question-wrap">
                <label>Faça uma pergunta sobre os dados</label>
                <textarea id="comercialUserQuestion" class="ai-question-input" rows="2" placeholder="Ex: Qual closer tem a melhor taxa de conversão? / Quantas vendas estão pendentes?"></textarea>
            </div>

            <!-- Botões de ação -->
            <div class="ai-action-buttons">
                <button class="ai-btn ai-btn-resumo" onclick="generateComercialAIAnalysis('resumo')" id="btnComercialAI">
                    <div class="ai-btn-icon">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
                        </svg>
                    </div>
                    <div class="ai-btn-text">
                        <span class="ai-btn-title">Gerar Resumo</span>
                        <span class="ai-btn-sub">Insights e recomendações</span>
                    </div>
                </button>
                <button class="ai-btn ai-btn-pergunta" onclick="generateComercialAIAnalysis('pergunta')" id="btnComercialQuestion">
                    <div class="ai-btn-icon">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                    </div>
                    <div class="ai-btn-text">
                        <span class="ai-btn-title">Perguntar</span>
                        <span class="ai-btn-sub">Resposta sobre um dado</span>
                    </div>
                </button>
            </div>

            <!-- Barra inferior: config + API status + GID opcional -->
            <div class="ai-bottom-bar">
                <button class="ai-config-btn" onclick="openComercialConfigModal()" title="Configurar API Key">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
                <span id="comercialApiStatus" class="ai-api-status api-status-indicator"></span>
                <details class="ai-gid-toggle">
                    <summary>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                        GID opcional
                    </summary>
                    <div class="ai-gid-row">
                        <input type="text" id="comercialGidInput" class="ai-gid-input" placeholder="GID da aba" />
                        <button onclick="fetchComercialData()" id="btnFetchComercial" class="ai-gid-btn">Buscar</button>
                        <span id="comercialFetchStatus" class="comercial-fetch-status"></span>
                    </div>
                </details>
            </div>

            <div id="comercialAiLoading" class="ai-loading" style="display: none;">
                <div class="spinner"></div>
                <span>Analisando dados comerciais com Claude AI...</span>
            </div>

            <!-- Resposta da pergunta -->
            <div id="comercialAnswerResult" style="display: none;">
                <div class="ai-result-card">
                    <h3>Resposta</h3>
                    <div id="comercialAnswerText" style="color: #D1D5DB; line-height: 1.6; white-space: pre-wrap;"></div>
                </div>
            </div>

            <!-- Resultados do resumo -->
            <div id="comercialAiResults" style="display: none;">
                <div class="ai-results-grid">
                    <div class="ai-result-card"><h3>Insights</h3><ul class="insight-list" id="comercialInsightsList"></ul></div>
                    <div class="ai-result-card"><h3>Alertas e Previsões</h3><ul class="insight-list" id="comercialAlertsList"></ul></div>
                </div>
                <div class="ai-result-card" style="margin-top: 20px;">
                    <h3>Recomendações</h3>
                    <div id="comercialRecommendationsList" class="recommendations-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Config API -->
    <div id="comercialConfigModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configuração da API</h3>
                <button class="modal-close" onclick="closeComercialConfigModal()">&times;</button>
            </div>
            <div class="modal-body">
                <label for="comercialApiKeyInput">Chave da API Anthropic (Claude)</label>
                <input type="password" id="comercialApiKeyInput" placeholder="sk-ant-api03-..." />
                <p class="api-help">Obtenha sua chave em: <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: #35cca3;">console.anthropic.com</a></p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeComercialConfigModal()">Cancelar</button>
                <button class="btn-primary" onclick="saveComercialApiKey()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <script>
        // ===================================
        // CONFIGURAÇÃO
        // ===================================
        const DASH_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRI1EKZHFoHXg58egC-gRnZb1Ul7EDKoB9bqPwDd0qAEoHtuVlFi2dnbMD0MGN7GLbi_Dql9gc2-lhJ/pub';
        const COMERCIAL_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSSQ7mve2qz75gYNsmGqBj8yuyQO5JQU80qBcULnAYJ0MdYh373F0RD0DGc0Qpb5z7AjTdyyGyXQ1BP/pub';

        const GIDS = {
            dados: 0,
            closer: 1901844287,
            ultimaVenda: 697721200
        };

        let kpiChart = null;
        let autoRefreshTimer = null;
        let lastTodayValue = 0;
        let firebaseListenerActive = false;
        let lastFirebaseHash = '';
        let lastFirebaseUpdatedAt = 0; // Timestamp do último sync do Apps Script
        let currentViewMode = 'live'; // 'live' ou '2025-02' etc.
        let appsScriptRealtimeActive = false; // True quando Apps Script está enviando dados via Firebase

        // ===================================
        // SIDEBAR
        // ===================================
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() { document.getElementById('sidebar').classList.add('ready'); }, 50);
        });

        function toggleSidebar() {
            var sidebar = document.getElementById('sidebar');
            var overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                var sidebar = document.getElementById('sidebar');
                if (sidebar.classList.contains('active')) toggleSidebar();
            }
        });

        // ===================================
        // CSV PARSER
        // ===================================
        function parseCSVLine(line) {
            var result = [], current = '', inQuotes = false;
            for (var i = 0; i < line.length; i++) {
                var ch = line[i];
                if (ch === '"') {
                    if (inQuotes && line[i + 1] === '"') { current += '"'; i++; }
                    else inQuotes = !inQuotes;
                } else if (ch === ',' && !inQuotes) {
                    result.push(current.trim()); current = '';
                } else {
                    current += ch;
                }
            }
            result.push(current.trim());
            return result;
        }

        function parseMoneyValue(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/R\$\s?/g, '').replace(/\./g, '').replace(',', '.')) || 0;
        }

        function formatMoney(value) {
            return 'R$ ' + value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // ===================================
        // FETCH DATA FROM SHEETS
        // ===================================
        async function fetchSheetCSV(gid) {
            var url = DASH_SHEET_URL + '?gid=' + gid + '&single=true&output=csv&_t=' + Date.now();
            var response = await fetch(url, { cache: 'no-store' });
            if (!response.ok) throw new Error('HTTP ' + response.status);
            return await response.text();
        }

        // ===================================
        // TOAST NOTIFICATION
        // ===================================
        function showNotification(message, type) {
            var existing = document.querySelector('.comercial-notification');
            if (existing) existing.remove();

            var colors = {
                success: { bg: 'rgba(53, 204, 163, 0.15)', border: '#35CCA3', text: '#35CCA3' },
                error:   { bg: 'rgba(224, 93, 93, 0.15)',  border: '#E05D5D', text: '#E05D5D' },
                info:    { bg: 'rgba(22, 150, 179, 0.15)',  border: '#1696B3', text: '#1696B3' }
            };
            var c = colors[type] || colors.info;

            var icons = {
                success: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
                error:   '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
                info:    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>'
            };

            var notification = document.createElement('div');
            notification.className = 'comercial-notification';
            notification.innerHTML = '<span style="display:flex;align-items:center;gap:8px;color:' + c.text + '">' + (icons[type] || icons.info) + ' ' + message + '</span>';
            Object.assign(notification.style, {
                position: 'fixed',
                top: '24px',
                right: '24px',
                background: c.bg,
                border: '1px solid ' + c.border,
                borderRadius: '12px',
                padding: '12px 20px',
                fontSize: '13px',
                fontFamily: "'Poppins', sans-serif",
                fontWeight: '500',
                backdropFilter: 'blur(10px)',
                zIndex: '10000',
                opacity: '0',
                transform: 'translateY(-10px)',
                transition: 'all 0.3s ease'
            });

            document.body.appendChild(notification);
            requestAnimationFrame(function() {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            });

            setTimeout(function() {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(10px)';
                setTimeout(function() { notification.remove(); }, 300);
            }, 3000);
        }

        async function loadDashboardData() {
            var btn = document.getElementById('btnRefreshDash');
            if (btn) btn.classList.add('loading');
            showNotification('Sincronizando dados...', 'info');

            try {
                // Fetch all 3 tabs in parallel
                var [dadosCSV, closerCSV, vendaCSV] = await Promise.all([
                    fetchSheetCSV(GIDS.dados),
                    fetchSheetCSV(GIDS.closer),
                    fetchSheetCSV(GIDS.ultimaVenda)
                ]);

                // Parse Dados (KPIs)
                var dadosLines = dadosCSV.split('\n').filter(function(l) { return l.trim(); });
                var dadosHeaders = parseCSVLine(dadosLines[0]);
                var dadosValues = dadosLines.length > 1 ? parseCSVLine(dadosLines[1]) : [];

                // Build KPI map by header name
                var kpis = {};
                for (var i = 0; i < dadosHeaders.length; i++) {
                    kpis[dadosHeaders[i]] = dadosValues[i] || '';
                }

                // Parse Closer (ranking)
                var closerLines = closerCSV.split('\n').filter(function(l) { return l.trim(); });
                var closers = [];
                for (var i = 1; i < closerLines.length; i++) {
                    var cols = parseCSVLine(closerLines[i]);
                    if (cols[0]) {
                        closers.push({
                            nome: cols[0],
                            taxaConversao: cols[1] || '0%',
                            totalVendas: cols[2] || 'R$ 0,00',
                            foto: cols[3] || '',
                            pendente: cols[4] || ''
                        });
                    }
                }

                // Sort closers by total sales (descending)
                closers.sort(function(a, b) {
                    return parseMoneyValue(b.totalVendas) - parseMoneyValue(a.totalVendas);
                });

                // Parse Última Venda
                var vendaLines = vendaCSV.split('\n').filter(function(l) { return l.trim(); });
                var ultimaVenda = null;
                if (vendaLines.length > 1) {
                    var vCols = parseCSVLine(vendaLines[1]);
                    ultimaVenda = { closer: vCols[0] || '', foto: vCols[1] || '', valor: vCols[2] || '' };
                }

                // RENDER
                renderKPIs(kpis, closers);
                renderChart(kpis);
                renderRanking(closers);
                renderToday(kpis, ultimaVenda);

                // Sincronizar dados para Firebase (real-time para outros clientes)
                syncToFirebase(kpis, closers, ultimaVenda);

                // Salvar snapshot mensal (histórico)
                saveMonthlySnapshot(kpis, closers, ultimaVenda);

                // Show dashboard, hide loading
                document.getElementById('dashLoading').style.display = 'none';
                document.getElementById('dashGrid').style.display = 'grid';

                console.log('Dashboard atualizado com sucesso');
                showNotification('Dashboard atualizado!', 'success');

            } catch (error) {
                console.error('Erro ao carregar dados do dashboard:', error);
                showNotification('Erro ao atualizar dados', 'error');
                document.getElementById('dashLoading').innerHTML = '<p style="color:#f87171;">Erro ao carregar dados: ' + error.message + '</p><button class="btn-refresh" onclick="loadDashboardData()" style="margin-top:16px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Tentar novamente</button>';
            } finally {
                if (btn) btn.classList.remove('loading');
            }
        }

        // ===================================
        // RENDER KPIs
        // ===================================
        function renderKPIs(kpis, closers) {
            // Vendas do mês (Total)
            document.getElementById('kpiVendasTotal').textContent = kpis['Total'] || 'R$ 0,00';

            // Taxa de Conversão — média global calculada a partir dos closers
            var taxaMedia = 0;
            if (closers && closers.length > 0) {
                var soma = 0;
                for (var i = 0; i < closers.length; i++) {
                    var taxa = closers[i].taxaConversao.replace('%', '').replace(',', '.').trim();
                    soma += parseFloat(taxa) || 0;
                }
                taxaMedia = soma / closers.length;
            }
            document.getElementById('kpiTaxaConversao').textContent = taxaMedia.toFixed(2).replace('.', ',') + '%';

            // Contratos Gerados (campo "Equipe" na planilha)
            document.getElementById('kpiGerados').textContent = kpis['Equipe'] || kpis['Gerados'] || 'R$ 0,00';

            // Meta Semanal
            document.getElementById('kpiMetaSemanal').textContent = kpis['Meta Semanal'] || 'R$ 0,00';

            // Contratos do mês
            document.getElementById('contratosPagos').querySelector('span').textContent = kpis['Contratos Assinados'] || '0';
            document.getElementById('contratosPendentes').querySelector('span').textContent = kpis['Contratos Pendentes'] || '0';
        }

        // ===================================
        // RENDER CHART
        // ===================================
        function renderChart(kpis) {
            var ctx = document.getElementById('kpiChart').getContext('2d');

            var metaValue = parseMoneyValue(kpis['Meta']);

            var items = [
                { label: 'Assinados', value: parseMoneyValue(kpis['Assinados']), color: '#35CCA3' },
                { label: 'Gerados', value: parseMoneyValue(kpis['Equipe'] || kpis['Gerados']), color: '#68C9AE' },
                { label: 'Total', value: parseMoneyValue(kpis['Total']), color: '#2FB490' },
                { label: 'Desistentes', value: parseMoneyValue(kpis['Desistentes']), color: '#E05D5D' },
                { label: 'Pendentes', value: parseMoneyValue(kpis['Pendentes']), color: '#E8BB34' }
            ];

            // Ordenar do maior para o menor
            items.sort(function(a, b) { return b.value - a.value; });

            var labels = items.map(function(i) { return i.label; });
            var values = items.map(function(i) { return i.value; });
            var colors = items.map(function(i) { return i.color; });

            if (kpiChart) kpiChart.destroy();

            // Plugin da linha tracejada da meta
            var metaLinePlugin = {
                id: 'metaLine',
                afterDraw: function(chart) {
                    if (!metaValue) return;
                    var yScale = chart.scales.y;
                    var yPos = yScale.getPixelForValue(metaValue);
                    var ctx = chart.ctx;
                    ctx.save();
                    ctx.beginPath();
                    ctx.setLineDash([8, 5]);
                    ctx.strokeStyle = '#0DABCE';
                    ctx.lineWidth = 1.5;
                    ctx.globalAlpha = 0.7;
                    ctx.moveTo(chart.chartArea.left, yPos);
                    ctx.lineTo(chart.chartArea.right, yPos);
                    ctx.stroke();
                    // Label da meta na direita
                    ctx.fillStyle = '#0DABCE';
                    ctx.font = "600 11px 'Poppins', sans-serif";
                    ctx.textAlign = 'right';
                    ctx.globalAlpha = 1;
                    ctx.fillText('Meta: ' + formatMoney(metaValue), chart.chartArea.right, yPos - 6);
                    ctx.restore();
                }
            };

            kpiChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderRadius: 8,
                        borderSkipped: false,
                        maxBarThickness: 60
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 30, right: 10 } },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#e7e7e7',
                            font: { size: 11, weight: '700', family: 'Poppins' },
                            formatter: function(value) { return formatMoney(value); }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#b9c0ca', font: { size: 12, family: 'Poppins' } }
                        },
                        y: {
                            grace: '15%',
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                color: '#8c95a3',
                                font: { size: 11, family: 'Poppins' },
                                callback: function(v) {
                                    if (v >= 1000) return (v / 1000).toFixed(0) + ' mil';
                                    return v;
                                }
                            }
                        }
                    },
                    animation: { duration: 800 }
                },
                plugins: [ChartDataLabels, metaLinePlugin]
            });
        }

        // ===================================
        // RENDER RANKING
        // ===================================
        function renderRanking(closers) {
            var container = document.getElementById('rankingList');
            var html = '';

            closers.forEach(function(closer, idx) {
                var rank = idx + 1;
                var rankClass = rank <= 3 ? ' rank-' + rank : '';
                var pendingDisplay = closer.pendente ? closer.pendente : '';

                html += '<div class="ranking-item' + rankClass + '">';
                html += '<div class="rank-pos">' + rank + '</div>';
                html += '<div class="rank-info">';
                if (closer.foto) {
                    html += '<img class="rank-avatar" src="' + closer.foto + '" alt="' + closer.nome + '" onerror="this.style.display=\'none\'">';
                }
                html += '<div><div class="rank-name">' + closer.nome + '</div></div>';
                html += '</div>';
                html += '<div class="rank-sales-col">';
                html += '<div class="rank-sales">' + closer.totalVendas + '</div>';
                if (pendingDisplay) {
                    html += '<div class="rank-sales-pending">' + pendingDisplay + ' pendente</div>';
                }
                html += '</div>';
                html += '<div class="rank-conversion">' + closer.taxaConversao + '</div>';
                html += '</div>';
            });

            container.innerHTML = html;
        }

        // ===================================
        // SOM DE NOVA VENDA
        // ===================================
        var cashAudio = new Audio('assets/cash-sound.mp3');
        cashAudio.volume = 0.8;
        var audioUnlocked = false;

        // Desbloquear áudio no primeiro clique (política de autoplay do navegador)
        function unlockAudio() {
            if (audioUnlocked) return;
            cashAudio.play().then(function() {
                cashAudio.pause();
                cashAudio.currentTime = 0;
                audioUnlocked = true;
                console.log('Audio desbloqueado');
            }).catch(function() {});
        }
        document.addEventListener('click', unlockAudio, { once: false });
        document.addEventListener('touchstart', unlockAudio, { once: false });
        document.addEventListener('keydown', unlockAudio, { once: false });

        function playCashSound() {
            cashAudio.currentTime = 0;
            cashAudio.play().catch(function(e) {
                console.log('Audio bloqueado pelo navegador, clique na tela para desbloquear');
            });
        }

        // ===================================
        // ANIMAÇÃO NOVA VENDA
        // ===================================
        function triggerCashAnimation() {
            var card = document.querySelector('.today-card');
            var value = document.getElementById('todayValue');

            // Reset animations
            card.classList.remove('cash-animation');
            value.classList.remove('cash-animation');
            void card.offsetWidth;

            // Trigger card + value animations
            card.classList.add('cash-animation');
            value.classList.add('cash-animation');

            // === CONFETES pela tela inteira ===
            var confettiColors = ['#35CCA3', '#68C9AE', '#E8BB34', '#0DABCE', '#2FB490', '#E7E7E7'];
            var shapes = ['circle', 'rect'];
            for (var i = 0; i < 60; i++) {
                (function(idx) {
                    setTimeout(function() {
                        var el = document.createElement('div');
                        el.className = 'confetti-piece';
                        var color = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                        var shape = shapes[Math.floor(Math.random() * shapes.length)];
                        el.style.background = color;
                        el.style.borderRadius = shape === 'circle' ? '50%' : '2px';
                        el.style.width = (6 + Math.random() * 8) + 'px';
                        el.style.height = (6 + Math.random() * 8) + 'px';
                        el.style.left = (Math.random() * 100) + 'vw';
                        el.style.top = '-10px';
                        el.style.animationDuration = (2 + Math.random() * 2) + 's';
                        el.style.animationDelay = (Math.random() * 0.5) + 's';
                        document.body.appendChild(el);
                        setTimeout(function() { el.remove(); }, 5000);
                    }, idx * 30);
                })(i);
            }

            // === Chuva de dinheiro no card ===
            var moneyEmojis = ['💰', '💵', '💲', '🤑', '💎', '🏆'];
            card.style.position = 'relative';
            for (var j = 0; j < 8; j++) {
                (function(idx) {
                    setTimeout(function() {
                        var el = document.createElement('div');
                        el.className = 'money-rain';
                        el.textContent = moneyEmojis[idx % moneyEmojis.length];
                        el.style.left = (5 + Math.random() * 85) + '%';
                        el.style.top = (-5 + Math.random() * 20) + '%';
                        card.appendChild(el);
                        setTimeout(function() { el.remove(); }, 3000);
                    }, idx * 150);
                })(j);
            }

            // Limpar classes
            setTimeout(function() {
                card.classList.remove('cash-animation');
                value.classList.remove('cash-animation');
            }, 3000);

            // Tocar som
            playCashSound();
        }

        // ===================================
        // RENDER CONTRATADOS HOJE
        // ===================================
        function renderToday(kpis, ultimaVenda) {
            var diaValue = kpis['Dia'] || 'R$ 0,00';
            var metaDiaria = kpis['Meta Diária'] || 'R$ 3.500,00';
            var diaNum = parseMoneyValue(diaValue);

            document.getElementById('todayValue').textContent = diaValue;
            document.getElementById('todayProgressCurrent').textContent = diaValue;
            document.getElementById('todayProgressMeta').textContent = metaDiaria;

            // Detectar aumento de valor — dispara animação + som
            if (lastTodayValue > 0 && diaNum > lastTodayValue) {
                triggerCashAnimation();
            }
            lastTodayValue = diaNum;

            // Progress bar
            var metaNum = parseMoneyValue(metaDiaria);
            var pct = metaNum > 0 ? Math.min((diaNum / metaNum) * 100, 100) : 0;
            document.getElementById('todayProgressFill').style.width = pct + '%';

            // Última venda
            if (ultimaVenda && ultimaVenda.closer) {
                document.getElementById('lastSaleCloser').innerHTML = ultimaVenda.closer + '<span class="elite"> | Elite</span>';
                document.getElementById('lastSaleValue').textContent = ultimaVenda.valor;
                var avatar = document.getElementById('lastSaleAvatar');
                if (ultimaVenda.foto) {
                    avatar.src = ultimaVenda.foto;
                    avatar.style.display = 'block';
                }
            }
        }

        // ===================================
        // FIREBASE REAL-TIME SYNC
        // ===================================

        // Gerar hash simples para detectar mudanças
        function simpleHash(str) {
            var hash = 0;
            for (var i = 0; i < str.length; i++) {
                var char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(36);
        }

        // Salvar dados parsed no Firebase para real-time
        // NÃO escreve em comercial_live se Apps Script RT está ativo
        // (senão sobrescreve dados frescos com dados do CSV que pode estar em cache)
        function syncToFirebase(kpis, closers, ultimaVenda) {
            if (!isFirebaseReady()) return;

            // Se Apps Script está enviando dados via Firebase, não sobrescrever
            if (appsScriptRealtimeActive) {
                console.log('[Comercial] syncToFirebase ignorado — Apps Script RT ativo');
                return;
            }

            try {
                var dataToSync = {
                    kpis: kpis,
                    closers: closers,
                    ultimaVenda: ultimaVenda,
                    updatedAt: Date.now(),
                    updatedISO: new Date().toISOString(),
                    source: 'dashboard_csv'
                };

                database.ref('comercial_live').set(dataToSync);
                lastFirebaseHash = simpleHash(JSON.stringify(dataToSync.kpis) + JSON.stringify(dataToSync.closers));
                lastFirebaseUpdatedAt = dataToSync.updatedAt;
                console.log('Dados sincronizados para Firebase comercial_live');
            } catch (e) {
                console.error('Erro ao sincronizar para Firebase:', e);
            }
        }

        // Renderizar a partir de dados do Firebase
        function renderFromFirebaseData(data) {
            if (!data || !data.kpis) return;

            var kpis = data.kpis;
            var closers = data.closers || [];
            var ultimaVenda = data.ultimaVenda || null;

            // Ordenar closers
            closers.sort(function(a, b) {
                return parseMoneyValue(b.totalVendas) - parseMoneyValue(a.totalVendas);
            });

            // Render
            renderKPIs(kpis, closers);
            renderChart(kpis);
            renderRanking(closers);
            renderToday(kpis, ultimaVenda);

            // Show dashboard
            document.getElementById('dashLoading').style.display = 'none';
            document.getElementById('dashGrid').style.display = 'grid';
        }

        // Iniciar listener Firebase em tempo real
        function startFirebaseListener() {
            if (!isFirebaseReady() || firebaseListenerActive) return;

            database.ref('comercial_live').on('value', function(snapshot) {
                if (!snapshot.exists()) return;

                var data = snapshot.val();

                // Se veio do Apps Script, marcar RT ativo e parar polling CSV
                if (data.source === 'apps_script' || data.source === 'apps_script_bulk') {
                    if (!appsScriptRealtimeActive) {
                        appsScriptRealtimeActive = true;
                        console.log('[Comercial RT] Apps Script detectado — desabilitando polling CSV');
                        if (autoRefreshTimer) { clearInterval(autoRefreshTimer); autoRefreshTimer = null; }
                        if (quickPollTimer) { clearInterval(quickPollTimer); quickPollTimer = null; }
                    }
                }

                // Deduplicação: Apps Script usa timestamp (sempre único a cada sync);
                // outras fontes usam hash do conteúdo para evitar re-render duplo.
                var isAppsScript = data.source === 'apps_script' || data.source === 'apps_script_bulk';
                if (isAppsScript) {
                    var t = data.updatedAt || 0;
                    if (t && t === lastFirebaseUpdatedAt) return;
                    lastFirebaseUpdatedAt = t;
                } else {
                    var newHash = simpleHash(JSON.stringify(data.kpis) + JSON.stringify(data.closers));
                    if (newHash === lastFirebaseHash) return;
                    lastFirebaseHash = newHash;
                }

                console.log('[Comercial RT] Dados alterados em tempo real! source=' + (data.source || 'unknown'));

                // Detectar se houve nova venda (valor do dia aumentou)
                var newDiaValue = parseMoneyValue(data.kpis['Dia'] || 'R$ 0,00');
                var isNewSale = lastTodayValue > 0 && newDiaValue > lastTodayValue;

                // Só atualizar se estiver no modo ao vivo
                if (currentViewMode !== 'live') return;

                showNotification('Dados atualizados em tempo real!', 'success');
                renderFromFirebaseData(data);

                // Auto-save: persistir snapshot no histórico sempre que RT atualizar
                saveMonthlySnapshot(data.kpis, data.closers, data.ultimaVenda);

                // Trigger animação de venda se o valor do dia aumentou
                if (isNewSale) {
                    setTimeout(function() { triggerCashAnimation(); }, 300);
                }
            });

            firebaseListenerActive = true;
            console.log('Firebase real-time listener ativo para comercial_live');
        }

        // ===================================
        // AUTO-REFRESH (5 min — sync planilha → Firebase)
        // Desabilitado automaticamente quando Apps Script RT está ativo
        // ===================================
        function startAutoRefresh() {
            if (appsScriptRealtimeActive) return; // Apps Script já envia em tempo real
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
            autoRefreshTimer = setInterval(function() {
                if (appsScriptRealtimeActive) { clearInterval(autoRefreshTimer); autoRefreshTimer = null; return; }
                console.log('Auto-refresh: sincronizando planilha → Firebase...');
                showNotification('Sincronizando com planilha...', 'info');
                loadDashboardData();
            }, 5 * 60 * 1000);
        }

        // ===================================
        // POLLING RÁPIDO (30s) — sync planilha → Firebase
        // Desabilitado automaticamente quando Apps Script RT está ativo
        // ===================================
        let quickPollTimer = null;

        function startQuickPoll() {
            if (appsScriptRealtimeActive) return; // Apps Script já envia em tempo real
            if (quickPollTimer) clearInterval(quickPollTimer);
            quickPollTimer = setInterval(async function() {
                if (appsScriptRealtimeActive) { clearInterval(quickPollTimer); quickPollTimer = null; return; }
                try {
                    var dadosCSV = await fetchSheetCSV(GIDS.dados);
                    var dadosLines = dadosCSV.split('\n').filter(function(l) { return l.trim(); });
                    var dadosHeaders = parseCSVLine(dadosLines[0]);
                    var dadosValues = dadosLines.length > 1 ? parseCSVLine(dadosLines[1]) : [];

                    var kpis = {};
                    for (var i = 0; i < dadosHeaders.length; i++) {
                        kpis[dadosHeaders[i]] = dadosValues[i] || '';
                    }

                    var newDiaValue = parseMoneyValue(kpis['Dia'] || 'R$ 0,00');

                    // Se o valor mudou, faz refresh completo (que vai sincronizar para Firebase)
                    if (newDiaValue !== lastTodayValue) {
                        console.log('Polling: mudança detectada! De ' + lastTodayValue + ' para ' + newDiaValue);
                        loadDashboardData();
                    }
                } catch (e) {
                    // Silencioso
                }
            }, 30 * 1000);
        }

        // ===================================
        // HISTÓRICO MENSAL
        // ===================================

        // Retorna chave do mês atual: "2025-02"
        function getCurrentMonthKey() {
            var now = new Date();
            var year = now.getFullYear();
            var month = (now.getMonth() + 1).toString().padStart(2, '0');
            return year + '-' + month;
        }

        // Retorna nome legível: "Fevereiro 2025"
        function getMonthLabel(monthKey) {
            var meses = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
            var parts = monthKey.split('-');
            var monthIndex = parseInt(parts[1]) - 1;
            return meses[monthIndex] + ' ' + parts[0];
        }

        // Salvar snapshot do mês atual no Firebase
        function saveMonthlySnapshot(kpis, closers, ultimaVenda) {
            if (!isFirebaseReady()) return;

            var monthKey = getCurrentMonthKey();

            var snapshot = {
                kpis: kpis,
                closers: closers,
                ultimaVenda: ultimaVenda,
                savedAt: Date.now(),
                savedISO: new Date().toISOString()
            };

            database.ref('comercial_history/' + monthKey).set(snapshot);
            console.log('Snapshot mensal salvo:', monthKey);
        }

        // Carregar lista de meses disponíveis e popular dropdown
        function loadMonthOptions() {
            if (!isFirebaseReady()) return;

            database.ref('comercial_history').once('value', function(snapshot) {
                var select = document.getElementById('comercialMonthFilter');
                if (!select || !snapshot.exists()) return;

                var data = snapshot.val();
                var months = Object.keys(data).sort().reverse();

                // Limpar opções antigas (manter "ao vivo")
                select.innerHTML = '<option value="live">Mês atual (ao vivo)</option>';

                var currentMonth = getCurrentMonthKey();

                for (var i = 0; i < months.length; i++) {
                    var opt = document.createElement('option');
                    opt.value = months[i];
                    opt.textContent = getMonthLabel(months[i]);
                    if (months[i] === currentMonth) {
                        opt.textContent += ' (atual)';
                    }
                    select.appendChild(opt);
                }
            });
        }

        // Navegar para um mês específico
        function handleComercialMonthChange(value) {
            currentViewMode = value;

            if (value === 'live') {
                // Voltar ao modo ao vivo
                showNotification('Voltando ao modo ao vivo...', 'info');
                if (!appsScriptRealtimeActive) {
                    // Sem Apps Script RT: usar polling CSV
                    loadDashboardData();
                    startAutoRefresh();
                    startQuickPoll();
                }
                // Com Apps Script RT: o listener já vai renderizar os dados atuais
                return;
            }

            // Parar atualizações automáticas ao ver histórico
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
            if (quickPollTimer) clearInterval(quickPollTimer);

            // Carregar dados do mês do Firebase
            showNotification('Carregando ' + getMonthLabel(value) + '...', 'info');

            database.ref('comercial_history/' + value).once('value', function(snapshot) {
                if (!snapshot.exists()) {
                    showNotification('Nenhum dado encontrado para este mês', 'error');
                    return;
                }

                var data = snapshot.val();
                renderFromFirebaseData(data);
                showNotification(getMonthLabel(value) + ' carregado!', 'success');
            });
        }

        // ===================================
        // INIT
        // ===================================
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            startAutoRefresh();
            startQuickPoll();

            // Iniciar Firebase listener quando estiver pronto
            if (typeof isFirebaseReady === 'function' && isFirebaseReady()) {
                startFirebaseListener();
                loadMonthOptions();
            } else {
                window.addEventListener('firebaseReady', function() {
                    startFirebaseListener();
                    loadMonthOptions();
                });
            }
        });

        // ===================================
        // ===================================
        // IA COMERCIAL — FIREBASE RT + PERGUNTA CUSTOM
        // ===================================

        // Cache dos dados em tempo real para a IA
        var comercialAIData = null;

        // Atualizar status dos dados quando Firebase atualiza
        function updateComercialDataStatus() {
            var statusEl = document.getElementById('comercialDataStatusText');
            var containerEl = document.getElementById('comercialDataStatus');
            if (!statusEl) return;

            if (comercialAIData) {
                var kpiCount = comercialAIData.kpis ? Object.keys(comercialAIData.kpis).length : 0;
                var closerCount = comercialAIData.closers ? comercialAIData.closers.length : 0;
                var time = comercialAIData.updatedISO ? new Date(comercialAIData.updatedISO).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
                statusEl.textContent = 'Dados em tempo real: ' + kpiCount + ' KPIs, ' + closerCount + ' closers' + (time ? ' (atualizado ' + time + ')' : '');
                if (containerEl) containerEl.classList.remove('waiting');
            } else {
                statusEl.textContent = 'Aguardando dados do Firebase...';
                if (containerEl) containerEl.classList.add('waiting');
            }
        }

        // Escutar dados do comercial_live para a IA
        document.addEventListener('firebaseReady', function() {
            if (typeof database !== 'undefined' && database) {
                database.ref('comercial_live').on('value', function(snapshot) {
                    if (snapshot.exists()) {
                        comercialAIData = snapshot.val();
                        updateComercialDataStatus();
                    }
                });
            }

            // Carregar GID salvo (opcional)
            if (typeof getComercialGidFromFirebase === 'function') {
                getComercialGidFromFirebase().then(function(savedGid) {
                    var gidInput = document.getElementById('comercialGidInput');
                    if (gidInput && savedGid) gidInput.value = savedGid;
                }).catch(function() {});
            }
        });

        // Formatar dados do Firebase RT para texto legível pela IA
        function formatFirebaseDataForAI() {
            if (!comercialAIData) return '';

            var text = '';
            var kpis = comercialAIData.kpis || {};
            var closers = comercialAIData.closers || [];
            var ultimaVenda = comercialAIData.ultimaVenda || null;

            // KPIs
            text += '=== RESUMO / KPIs DO PERIODO ===\n';
            for (var key in kpis) {
                if (kpis.hasOwnProperty(key)) {
                    text += key + ': ' + kpis[key] + '\n';
                }
            }

            // Closers
            if (closers.length > 0) {
                text += '\n=== CLOSERS / VENDEDORES ===\n';
                closers.forEach(function(c) {
                    var parts = [];
                    if (c.nome) parts.push('Nome: ' + c.nome);
                    if (c.total) parts.push('Total: ' + c.total);
                    if (c.conversao) parts.push('Conversao: ' + c.conversao);
                    if (c.contratos) parts.push('Contratos: ' + c.contratos);
                    if (c.meta) parts.push('Meta: ' + c.meta);
                    if (parts.length > 0) text += parts.join(' | ') + '\n';
                });
            }

            // Ultima venda
            if (ultimaVenda) {
                text += '\n=== ULTIMA VENDA ===\n';
                for (var vKey in ultimaVenda) {
                    if (ultimaVenda.hasOwnProperty(vKey)) {
                        text += vKey + ': ' + ultimaVenda[vKey] + '\n';
                    }
                }
            }

            return text.trim();
        }

        // Buscar dados adicionais via GID (opcional)
        async function fetchComercialData() {
            var gidInput = document.getElementById('comercialGidInput');
            var gid = gidInput ? gidInput.value.trim() : '';
            var statusEl = document.getElementById('comercialFetchStatus');
            var btn = document.getElementById('btnFetchComercial');

            if (!gid) {
                if (statusEl) { statusEl.textContent = 'Informe o GID.'; statusEl.style.color = '#f87171'; }
                return;
            }

            if (typeof saveComercialGidToFirebase === 'function') {
                await saveComercialGidToFirebase(gid);
            }

            if (btn) btn.disabled = true;
            if (statusEl) { statusEl.textContent = 'Buscando...'; statusEl.style.color = '#B9C0CA'; }

            try {
                var csvUrl = COMERCIAL_SHEET_URL + '?gid=' + gid + '&single=true&output=csv&_t=' + Date.now();
                var response = await fetch(csvUrl, { cache: 'no-store' });
                if (!response.ok) throw new Error('HTTP ' + response.status);

                var csvText = await response.text();
                var lines = csvText.split('\n').filter(function(l) { return l.trim(); });
                if (lines.length < 2) throw new Error('Vazia');

                var headers = parseCSVLine(lines[0]);
                var cleanHeaders = headers.map(function(h, idx) {
                    var t = (h || '').trim();
                    if (idx === 0) return 'Indicador';
                    if (idx === 1) return 'Valor_KPI';
                    return t;
                });

                var kpiSection = '';
                var dataSection = '';
                var dataCount = 0;

                for (var i = 1; i < lines.length; i++) {
                    var values = parseCSVLine(lines[i]);
                    var mainDataCount = 0;
                    for (var k = 2; k < values.length; k++) {
                        var val = (values[k] || '').trim();
                        if (val && val !== 'R$ 0,00') mainDataCount++;
                    }

                    if (mainDataCount === 0) {
                        var colA = (values[0] || '').trim();
                        var colB = (values[1] || '').trim();
                        if (colA && colB) kpiSection += colA + ': ' + colB + '\n';
                        continue;
                    }

                    var colA2 = (values[0] || '').trim();
                    var colB2 = (values[1] || '').trim();
                    if (colA2 && colB2) kpiSection += colA2 + ': ' + colB2 + '\n';

                    var row = [];
                    for (var j = 2; j < cleanHeaders.length; j++) {
                        var h = cleanHeaders[j];
                        var v = (values[j] || '').trim();
                        if (h && v) row.push(h + ': ' + v);
                    }
                    if (row.length > 0) { dataSection += row.join(' | ') + '\n'; dataCount++; }
                }

                var formattedData = '';
                if (kpiSection.trim()) formattedData += '=== NEGOCIACOES (via GID) ===\n' + kpiSection.trim() + '\n\n';
                formattedData += dataSection.trim();

                // Adicionar ao cache
                if (!comercialAIData) comercialAIData = {};
                comercialAIData._gidExtra = formattedData;

                if (statusEl) { statusEl.textContent = dataCount + ' registros'; statusEl.style.color = '#35cca3'; }

            } catch (error) {
                if (statusEl) { statusEl.textContent = 'Erro: ' + error.message; statusEl.style.color = '#f87171'; }
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        function getComercialApiKey() { return localStorage.getItem('anthropic_api_key') || ''; }
        function hasComercialApiKey() { var key = getComercialApiKey(); return key && key.startsWith('sk-ant-'); }

        function updateComercialApiStatus() {
            var el = document.getElementById('comercialApiStatus');
            if (el) {
                if (hasComercialApiKey()) { el.textContent = '\u2713 API configurada'; el.style.color = '#35cca3'; }
                else { el.textContent = '\u2717 Sem API Key'; el.style.color = '#f87171'; }
            }
        }

        function toggleComercialAI() {
            var panel = document.getElementById('comercialAiPanel');
            var fab = document.getElementById('btnComercialAIFab');
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
                fab.classList.add('active');
                updateComercialApiStatus();
                updateComercialDataStatus();
            } else {
                panel.style.display = 'none';
                fab.classList.remove('active');
            }
        }

        function openComercialConfigModal() { var m = document.getElementById('comercialConfigModal'); var i = document.getElementById('comercialApiKeyInput'); if (m) { m.style.display = 'flex'; if (i) i.value = getComercialApiKey(); } }
        function closeComercialConfigModal() { var m = document.getElementById('comercialConfigModal'); if (m) m.style.display = 'none'; }

        function saveComercialApiKey() {
            var input = document.getElementById('comercialApiKeyInput');
            if (!input) return;
            var key = input.value.trim();
            if (!key.startsWith('sk-ant-')) { alert('Chave deve comecar com "sk-ant-"'); return; }
            localStorage.setItem('anthropic_api_key', key);
            closeComercialConfigModal();
            updateComercialApiStatus();
        }

        async function generateComercialAIAnalysis(mode) {
            // Obter dados do Firebase RT
            var rawData = formatFirebaseDataForAI();

            // Adicionar dados extras do GID se existirem
            if (comercialAIData && comercialAIData._gidExtra) {
                rawData += '\n\n' + comercialAIData._gidExtra;
            }

            if (!rawData) {
                alert('Nenhum dado disponivel. Aguarde os dados do Firebase ou use o GID.');
                return;
            }

            if (!hasComercialApiKey()) { openComercialConfigModal(); return; }

            var userQuestion = document.getElementById('comercialUserQuestion');
            var question = userQuestion ? userQuestion.value.trim() : '';

            // Se modo pergunta mas sem pergunta, avisar
            if (mode === 'pergunta' && !question) {
                alert('Digite uma pergunta no campo acima.');
                return;
            }

            var btnResumo = document.getElementById('btnComercialAI');
            var btnPergunta = document.getElementById('btnComercialQuestion');
            var loading = document.getElementById('comercialAiLoading');
            var results = document.getElementById('comercialAiResults');
            var answerResult = document.getElementById('comercialAnswerResult');

            if (btnResumo) btnResumo.disabled = true;
            if (btnPergunta) btnPergunta.disabled = true;
            if (loading) loading.style.display = 'flex';
            if (results) results.style.display = 'none';
            if (answerResult) answerResult.style.display = 'none';

            try {
                var prompt;
                if (mode === 'pergunta') {
                    prompt = buildQuestionPrompt(rawData, question);
                } else {
                    prompt = buildComercialPrompt(rawData);
                }

                var response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-api-key': getComercialApiKey(), 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
                    body: JSON.stringify({ model: 'claude-3-haiku-20240307', max_tokens: 3000, messages: [{ role: 'user', content: prompt }] })
                });

                if (!response.ok) { var err = await response.json(); throw new Error(err.error?.message || 'Erro na API'); }

                var result = await response.json();
                var content = result.content[0].text;

                if (mode === 'pergunta') {
                    // Modo pergunta: mostrar resposta em texto
                    var answerText = document.getElementById('comercialAnswerText');
                    if (answerText) answerText.textContent = content;
                    if (answerResult) answerResult.style.display = 'block';
                } else {
                    // Modo resumo: parse JSON
                    var jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error('Resposta invalida da IA');
                    var analysis = JSON.parse(jsonMatch[0]);

                    renderComercialInsights(analysis.insights || []);
                    renderComercialAlerts(analysis.alertas || []);
                    renderComercialRecommendations(analysis.recommendations || []);
                    if (results) results.style.display = 'block';
                }

            } catch (error) {
                console.error('Erro na analise IA comercial:', error);
                alert('Erro: ' + error.message);
            } finally {
                if (btnResumo) btnResumo.disabled = false;
                if (btnPergunta) btnPergunta.disabled = false;
                if (loading) loading.style.display = 'none';
            }
        }

        function buildQuestionPrompt(rawData, question) {
            return 'Voce e um analista comercial especializado. Responda a pergunta abaixo com base APENAS nos dados fornecidos.\n\nSeja direto, objetivo e use numeros/valores quando possivel. Responda em portugues.\n\n## DADOS COMERCIAIS ATUAIS (TEMPO REAL):\n\n' + rawData + '\n\n## PERGUNTA:\n\n' + question + '\n\nResponda de forma clara e concisa.';
        }

        function buildComercialPrompt(rawData) {
            return 'Você é um analista comercial especializado em performance de vendas de SaaS B2B.\n\nAnalise os seguintes dados comerciais e gere insights, alertas/previsões e recomendações de ações.\n\n## ESTRUTURA DOS DADOS:\n\nOs dados são divididos em duas seções:\n\n### SEÇÃO 1 — RESUMO / KPIs DO PERÍODO:\nIndicadores consolidados do mês, sempre nesta estrutura:\n- **Gerados**: Valor total gerado no período (R$)\n- **Assinados**: Valor total de contratos assinados (R$)\n- **Total**: Valor total do pipeline (R$)\n- **Dia**: Valor médio por dia útil (R$)\n- **Pendentes**: Valor total pendente de fechamento (R$)\n- **Meta**: Meta mensal de vendas (R$)\n- **Desistentes**: Valor perdido por desistências (R$)\n- **Taxa de Conversão**: Percentual individual de cada closer e da equipe geral\n- **Novos**: Valor de contratos novos (R$)\n- **Upsell**: Valor de upsell em clientes existentes (R$)\n- **Reativação**: Valor de reativações de clientes (R$)\n\n### SEÇÃO 2 — NEGOCIAÇÕES (cada linha é um lead/cliente):\nCada negociação possui os seguintes campos:\n- **Negociação**: Data em que o lead entrou no funil\n- **Contabilidade - RAZÃO SOCIAL**: Razão social / nome da empresa (ID interno)\n- **Nome/ Responsável**: Nome do contato principal do cliente\n- **Data o fechamento**: Data em que o cliente fechou (vazio = ainda não fechou)\n- **Closer**: Vendedor/especialista responsável pela negociação\n- **Status**: Estado atual — Pendente, Desistente, Contratado, Não Qualificado, Gerado\n- **Plano**: Tipo do plano — Enterprise, Professional, Starter, Avulso\n- **Clientes**: Quantidade de clientes que o plano comporta\n- **Valor**: Valor cheio do plano (sem desconto)\n- **Desc.**: Porcentagem de desconto aplicado\n- **Valor c/ desconto**: Valor final negociado com desconto\n- **Setup a vista**: Valor do setup pago à vista (R$ 0,00 se não pagou)\n- **Setup Parcelado**: Valor do setup parcelado\n- **Contrato**: Tipo — Novo, Reativação, Upsell, Indicação\n- **ID**: ID interno do lead/cliente\n- **Pagamento**: Status do pagamento — Pendente ou Pago (vazio = ainda sem pagamento)\n\n## DADOS COMERCIAIS DO PERÍODO:\n\n' + rawData + '\n\n## INSTRUÇÕES:\n\nUse o mapeamento de colunas acima para interpretar corretamente os dados CSV.\n\nGere uma análise em formato JSON com a seguinte estrutura:\n\n{\n  "insights": [\n    {\n      "tipo": "critico|alerta|positivo",\n      "titulo": "Título curto e impactante",\n      "descricao": "Descrição detalhada do insight baseado nos dados"\n    }\n  ],\n  "alertas": [\n    {\n      "nivel": "alto|medio|baixo",\n      "titulo": "Alerta ou previsão",\n      "descricao": "Detalhe do alerta, tendência ou previsão"\n    }\n  ],\n  "recommendations": [\n    {\n      "prioridade": 1,\n      "titulo": "Título da recomendação",\n      "descricao": "Descrição da ação recomendada",\n      "impacto": "Impacto esperado"\n    }\n  ]\n}\n\nIMPORTANTE:\n- Gere 4-6 insights sobre a performance comercial (conversão, ticket médio, comparativo entre closers, progresso vs meta, descontos praticados, mix de planos)\n- Gere 3-5 alertas ou previsões (tendências, riscos, gargalos no funil, desistências, pendentes sem fechamento, setup não pago, meta em risco)\n- Gere 4-5 recomendações práticas ordenadas por prioridade (ações para cada closer, estratégias de fechamento de pendentes, otimização de descontos, gestão de pipeline)\n- Baseie-se APENAS nos dados fornecidos\n- Seja específico com números e porcentagens\n- Compare performance entre closers usando taxa de conversão, valor total negociado e quantidade de contratos\n- Analise a distribuição por Status: quantos Contratados vs Pendentes vs Desistentes vs Gerados\n- Analise o mix de planos e tipos de contrato (Novo, Reativação, Upsell, Indicação)\n- Identifique clientes Pendentes que têm alto valor como oportunidades prioritárias\n- Use os dados de resumo (Meta, Gerados, Assinados, Pendentes, Desistentes) para calcular progresso e projeções\n- Projete tendências se possível\n\nResponda APENAS com o JSON, sem texto adicional.';
        }

        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function renderComercialInsights(insights) {
            var el = document.getElementById('comercialInsightsList');
            if (!el) return;
            var icons = { critico: '\uD83D\uDD34', alerta: '\uD83D\uDFE1', positivo: '\uD83D\uDFE2' };
            el.innerHTML = insights.map(function(i) {
                return '<li><strong>' + (icons[i.tipo] || '\uD83D\uDD35') + ' ' + escapeHTML(i.titulo) + ':</strong> ' + escapeHTML(i.descricao) + '</li>';
            }).join('');
        }

        function renderComercialAlerts(alerts) {
            var el = document.getElementById('comercialAlertsList');
            if (!el) return;
            var icons = { alto: '\uD83D\uDD34', medio: '\uD83D\uDFE1', baixo: '\uD83D\uDFE2' };
            el.innerHTML = alerts.map(function(a) {
                return '<li><strong>' + (icons[a.nivel] || '\uD83D\uDFE1') + ' ' + escapeHTML(a.titulo) + ':</strong> ' + escapeHTML(a.descricao) + '</li>';
            }).join('');
        }

        function renderComercialRecommendations(recs) {
            var el = document.getElementById('comercialRecommendationsList');
            if (!el) return;
            el.innerHTML = recs.map(function(rec, i) {
                return '<article class="recommendation-card"><h4>' + (i + 1) + '. ' + escapeHTML(rec.titulo) + '</h4><p>' + escapeHTML(rec.descricao) + '</p>' +
                    (rec.impacto ? '<p style="color: #35cca3; font-size: 0.9em; margin-top: 10px;"><strong>Impacto esperado:</strong> ' + escapeHTML(rec.impacto) + '</p>' : '') +
                    '</article>';
            }).join('');
        }

        document.addEventListener('DOMContentLoaded', updateComercialApiStatus);
    </script>
    </div>
</body>
</html>
