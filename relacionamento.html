<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hubstrom - Relacionamento</title>

    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Cpath d='M161 85c2.7-1.2 5.6.8 5.6 3.7v50.3c0 1.6-.9 3-2.4 3.7L35.2 199.9c-.9.4-1.9-.3-1.9-1.2v-54.4c0-1.6.9-3 2.4-3.7L161 85z' fill='%2335CCA3'/%3E%3Cpath d='M164.8.1c.9-.4 1.9.3 1.9 1.2v54.4c0 1.6-.9 3-2.4 3.7L39 114.9c-2.7 1.2-5.6-.8-5.6-3.7V61c0-1.6.9-3 2.4-3.7L164.8.1z' fill='%2335CCA3'/%3E%3C/svg%3E">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="js/auth.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background: #0D1117; color: #E7E7E7; overflow-x: hidden; }

        /* =========== LAYOUT =========== */
        .rel-body {
            display: flex;
            flex-direction: column;
            gap: clamp(6px, 0.8vh, 12px);
            padding: clamp(6px, 0.8vh, 12px) clamp(8px, 1vw, 16px);
        }

        /* =========== KPI ROW =========== */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: clamp(6px, 0.7vw, 10px);
            flex-shrink: 0;
        }

        .kpi-tile {
            background: #161B22;
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            padding: clamp(8px, 1vh, 14px) clamp(10px, 1vw, 16px);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .kpi-tile-icon {
            width: clamp(32px, 3.5vw, 44px);
            height: clamp(32px, 3.5vw, 44px);
            border-radius: 9px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .kpi-tile-icon.green  { background: rgba(53,204,163,0.12); color: #35CCA3; }
        .kpi-tile-icon.red    { background: rgba(239,68,68,0.12);  color: #F87171; }
        .kpi-tile-icon.orange { background: rgba(251,146,60,0.12); color: #FB923C; }
        .kpi-tile-icon.blue   { background: rgba(99,102,241,0.12); color: #818CF8; }
        .kpi-tile-icon.yellow { background: rgba(234,179,8,0.12);  color: #EAB308; }
        .kpi-tile-icon.purple { background: rgba(168,85,247,0.12); color: #C084FC; }

        .kpi-tile-data { display: flex; flex-direction: column; }
        .kpi-tile-value {
            font-size: clamp(1.2em, 2vw, 1.8em);
            font-weight: 700;
            line-height: 1.1;
            color: #F0F0F0;
        }
        .kpi-tile-label {
            font-size: clamp(0.62em, 0.8vw, 0.78em);
            color: #6B7280;
            font-weight: 500;
        }

        /* =========== MAIN GRID =========== */
        .main-grid {
            display: grid;
            grid-template-columns: 38% 1fr;
            gap: clamp(6px, 0.7vw, 10px);
            height: clamp(380px, 68vh, 700px);
            overflow: hidden;
        }

        /* =========== CARDS =========== */
        .rel-card {
            background: #161B22;
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        .rel-card-title {
            display: flex; align-items: center; gap: 8px;
            padding: clamp(8px, 1vh, 12px) clamp(10px, 1.2vw, 16px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: clamp(0.72em, 0.9vw, 0.88em);
            font-weight: 600;
            color: #9CA3AF;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }
        .rel-card-title svg { color: #35CCA3; flex-shrink: 0; }
        .rel-card-body {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: clamp(8px, 1vh, 12px) clamp(10px, 1.2vw, 16px);
        }
        .rel-card-body::-webkit-scrollbar { width: 4px; }
        .rel-card-body::-webkit-scrollbar-track { background: transparent; }
        .rel-card-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

        /* =========== LEFT COLUMN =========== */
        .left-col {
            display: flex;
            flex-direction: column;
            gap: clamp(6px, 0.7vw, 10px);
            overflow: hidden;
            height: 100%;
        }

        /* Especialistas */
        .especialista-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: clamp(6px, 0.8vh, 10px) 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .especialista-item:last-child { border-bottom: none; }
        .esp-avatar {
            width: clamp(34px, 3vw, 44px);
            height: clamp(34px, 3vw, 44px);
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 2px solid rgba(53,204,163,0.3);
            background: #1E2530;
        }
        .esp-avatar-placeholder {
            width: clamp(34px, 3vw, 44px);
            height: clamp(34px, 3vw, 44px);
            border-radius: 50%;
            background: rgba(53,204,163,0.1);
            border: 2px solid rgba(53,204,163,0.3);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            font-size: 0.9em; font-weight: 600; color: #35CCA3;
        }
        .esp-info { flex: 1; min-width: 0; }
        .esp-name {
            font-size: clamp(0.8em, 0.9vw, 0.92em);
            font-weight: 600;
            color: #E7E7E7;
        }
        .esp-sub {
            font-size: clamp(0.68em, 0.75vw, 0.78em);
            color: #6B7280;
            margin-top: 2px;
        }
        .esp-total {
            font-size: clamp(1em, 1.2vw, 1.3em);
            font-weight: 700;
            color: #35CCA3;
            flex-shrink: 0;
        }
        .esp-health-bar {
            display: flex;
            height: 5px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
            gap: 1px;
        }
        .esp-health-seg { border-radius: 2px; }

        /* Planos chart area */
        .planos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: clamp(6px, 0.8vw, 10px);
        }
        .plano-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: clamp(8px, 1vh, 14px);
            gap: 4px;
            text-align: center;
        }
        .plano-name {
            font-size: clamp(0.72em, 0.8vw, 0.85em);
            color: #9CA3AF;
            font-weight: 500;
        }
        .plano-count {
            font-size: clamp(1.6em, 2.5vw, 2.2em);
            font-weight: 800;
            line-height: 1;
        }
        .plano-pct {
            font-size: clamp(0.68em, 0.75vw, 0.78em);
            color: #6B7280;
        }
        .plano-bar {
            width: 100%; height: 4px; border-radius: 2px;
            margin-top: 6px;
        }

        /* =========== RIGHT COLUMN =========== */
        .right-col {
            display: flex;
            flex-direction: column;
            gap: clamp(6px, 0.7vw, 10px);
            overflow: hidden;
            height: 100%;
        }

        /* Tabela de risco */
        .risco-table {
            width: 100%;
            border-collapse: collapse;
            font-size: clamp(0.7em, 0.8vw, 0.83em);
        }
        .risco-table th {
            text-align: left;
            padding: 6px 8px;
            color: #6B7280;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .risco-table th:hover { color: #9CA3AF; }
        .risco-table th.sort-active { color: #35CCA3; }
        .risco-table th .sort-arrow { margin-left: 4px; opacity: 0.5; font-style: normal; }
        .risco-table th.sort-active .sort-arrow { opacity: 1; }
        .risco-table td {
            padding: clamp(5px, 0.7vh, 8px) 8px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            vertical-align: middle;
        }
        .risco-table tr:last-child td { border-bottom: none; }
        .risco-table tr:hover td { background: rgba(255,255,255,0.02); }

        /* Health badges */
        .badge-health {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 3px 8px; border-radius: 20px;
            font-size: 0.85em; font-weight: 600;
            white-space: nowrap;
        }
        .badge-health::before {
            content: ''; width: 6px; height: 6px; border-radius: 50%;
        }
        .badge-health.em-dia    { background: rgba(53,204,163,0.12); color: #35CCA3; }
        .badge-health.em-dia::before { background: #35CCA3; }
        .badge-health.perigo    { background: rgba(251,146,60,0.12);  color: #FB923C; }
        .badge-health.perigo::before { background: #FB923C; }
        .badge-health.risco     { background: rgba(239,68,68,0.12);   color: #F87171; }
        .badge-health.risco::before  { background: #F87171; }
        .badge-health.outros    { background: rgba(107,114,128,0.12); color: #9CA3AF; }
        .badge-health.outros::before { background: #9CA3AF; }

        .esp-tag {
            display: flex; align-items: center; gap: 5px;
        }
        .esp-tag-avatar {
            width: 20px; height: 20px; border-radius: 50%; object-fit: cover;
            background: #1E2530; border: 1px solid rgba(53,204,163,0.2);
        }
        .esp-tag-name { color: #B9C0CA; }

        .badge-erros {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 20px; height: 20px; border-radius: 10px;
            background: rgba(239,68,68,0.15); color: #F87171;
            font-size: 0.82em; font-weight: 700; padding: 0 5px;
        }
        .badge-erros.zero { background: transparent; color: #4B5563; }

        /* Sem acesso */
        .acesso-item {
            display: flex; align-items: center; gap: 10px;
            padding: clamp(5px, 0.7vh, 8px) 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .acesso-item:last-child { border-bottom: none; }
        .acesso-cnpj { flex: 1; font-size: clamp(0.72em, 0.82vw, 0.85em); color: #B9C0CA; }
        .acesso-esp  { font-size: clamp(0.68em, 0.78vw, 0.8em); color: #6B7280; }
        .acesso-dias {
            font-size: clamp(0.72em, 0.82vw, 0.85em);
            font-weight: 600;
            padding: 2px 7px; border-radius: 6px;
        }
        .acesso-dias.critico  { background: rgba(239,68,68,0.12); color: #F87171; }
        .acesso-dias.atencao  { background: rgba(251,146,60,0.12); color: #FB923C; }
        .acesso-dias.nunca    { background: rgba(107,114,128,0.12); color: #6B7280; }

        /* HS chart */
        .hs-chart-wrap {
            display: flex; align-items: center; gap: clamp(10px, 1.5vw, 20px);
            height: 100%;
        }
        .hs-chart-canvas { flex-shrink: 0; }
        .hs-legend { display: flex; flex-direction: column; gap: 8px; flex: 1; }
        .hs-legend-item { display: flex; align-items: center; gap: 8px; }
        .hs-legend-dot {
            width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
        }
        .hs-legend-label { font-size: clamp(0.72em, 0.82vw, 0.85em); color: #9CA3AF; flex: 1; }
        .hs-legend-count { font-size: clamp(0.78em, 0.9vw, 0.9em); font-weight: 700; color: #E7E7E7; }
        .hs-legend-pct { font-size: 0.78em; color: #6B7280; margin-left: 2px; }

        /* RT status */
        .rt-badge {
            display: flex; align-items: center; gap: 6px;
            background: rgba(53,204,163,0.08); border: 1px solid rgba(53,204,163,0.15);
            border-radius: 20px; padding: 4px 10px;
            font-size: clamp(0.68em, 0.78vw, 0.8em); color: #35CCA3;
        }
        .rt-badge.offline { background: rgba(107,114,128,0.08); border-color: rgba(107,114,128,0.2); color: #6B7280; }
        .rt-dot {
            width: 7px; height: 7px; border-radius: 50%; background: #35CCA3;
            animation: rtPulse 2s ease-in-out infinite;
        }
        .rt-badge.offline .rt-dot { background: #6B7280; animation: none; }
        @keyframes rtPulse { 0%,100%{ opacity:1; } 50%{ opacity:0.3; } }

        /* Loading */
        .rel-loading {
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; gap: 14px;
            height: 100%; color: #6B7280; font-size: 0.9em;
        }
        .rel-spinner {
            width: 36px; height: 36px; border: 3px solid rgba(53,204,163,0.15);
            border-top-color: #35CCA3; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* =========== FILTRO GLOBAL DROPDOWN =========== */
        .gf-dropdown-wrap {
            position: relative;
        }
        .gf-dropdown-btn {
            display: flex; align-items: center; gap: 6px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 5px 10px;
            color: #9CA3AF;
            font-family: 'Poppins', sans-serif;
            font-size: clamp(0.7em,0.8vw,0.82em);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .gf-dropdown-btn:hover { background: rgba(255,255,255,0.07); color: #E7E7E7; }
        .gf-dropdown-btn.open  { border-color: rgba(53,204,163,0.3); color: #35CCA3; }
        .gf-dropdown-menu {
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: #1C2333;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            overflow: hidden;
            min-width: 160px;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        .gf-drop-opt {
            display: flex; align-items: center; gap: 8px;
            width: 100%; padding: 9px 14px;
            background: none; border: none;
            color: #9CA3AF;
            font-family: 'Poppins', sans-serif;
            font-size: clamp(0.72em,0.82vw,0.84em);
            font-weight: 500;
            cursor: pointer; text-align: left;
            transition: background 0.12s;
        }
        .gf-drop-opt:hover  { background: rgba(255,255,255,0.04); color: #E7E7E7; }
        .gf-drop-opt.active { background: rgba(53,204,163,0.07); color: #E7E7E7; font-weight: 600; }
        .gf-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .gf-opt-count { margin-left: auto; font-size: 0.9em; color: #4B5563; }

        /* =========== CLIENT TABS =========== */
        .client-tab {
            display: flex; align-items: center; gap: 6px;
            padding: clamp(8px,1vh,12px) clamp(12px,1.4vw,18px);
            background: none; border: none; border-bottom: 2px solid transparent;
            color: #6B7280; font-family: 'Poppins', sans-serif;
            font-size: clamp(0.72em, 0.88vw, 0.88em); font-weight: 600;
            cursor: pointer; transition: color 0.15s, border-color 0.15s;
            text-transform: uppercase; letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .client-tab:hover { color: #B9C0CA; }
        .client-tab.active { color: #E7E7E7; border-bottom-color: #35CCA3; }
        .client-tab svg { flex-shrink: 0; }
        .tab-badge {
            font-size: 0.85em; font-weight: 700;
            padding: 1px 7px; border-radius: 10px;
            letter-spacing: 0; text-transform: none;
        }
        .badge-red    { background: rgba(239,68,68,0.12);  color: #F87171; }
        .badge-purple { background: rgba(168,85,247,0.1);  color: #C084FC; }
        .badge-green  { background: rgba(53,204,163,0.12); color: #35CCA3; }
        .client-panel { border-top: 1px solid rgba(255,255,255,0.05); }

        /* =========== BUSCA CNPJ =========== */
        .cnpj-search-wrap {
            margin-left: auto;
            display: flex; align-items: center; gap: 6px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 5px 10px;
            transition: border-color 0.15s;
        }
        .cnpj-search-wrap:focus-within {
            border-color: rgba(53,204,163,0.35);
            background: rgba(53,204,163,0.04);
        }
        .cnpj-search-wrap svg { color: #4B5563; flex-shrink: 0; }
        .cnpj-search-input {
            background: none; border: none; outline: none;
            color: #E7E7E7;
            font-family: 'Poppins', sans-serif;
            font-size: clamp(0.7em, 0.8vw, 0.82em);
            width: clamp(100px, 12vw, 180px);
        }
        .cnpj-search-input::placeholder { color: #4B5563; }
        .cnpj-search-clear {
            background: none; border: none; cursor: pointer;
            color: #6B7280; font-size: 0.8em; padding: 0;
            line-height: 1; transition: color 0.15s;
        }
        .cnpj-search-clear:hover { color: #E7E7E7; }

        /* Header extras */
        .header-rt { margin-left: auto; display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>
<div class="container">

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Dashboards</h3>
            <button class="sidebar-close" onclick="toggleSidebar()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-item">
                <a href="index.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 20V10M12 20V4M6 20v-6"/>
                    </svg>
                    <span>Cancelamentos</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="comercial.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    <span>Comercial</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="analise-comercial.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                    </svg>
                    <span>Análise Comercial</span>
                </a>
            </li>
            <li class="sidebar-item active">
                <a href="relacionamento.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>Relacionamento</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="suporte.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span>Suporte</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a href="log-erros.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <span>Log de Erros</span>
                </a>
            </li>
            <li class="sidebar-item sidebar-admin-only">
                <a href="admin.html">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    <span>Admin</span>
                </a>
            </li>
        </ul>
    </nav>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-top">
            <button class="hamburger-btn" onclick="toggleSidebar()" title="Menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <line x1="3" y1="12" x2="21" y2="12"/>
                    <line x1="3" y1="18" x2="21" y2="18"/>
                </svg>
            </button>
            <h1 class="header-title">Dashboard Relacionamento</h1>
            <div class="header-rt">
                <!-- Dropdown filtro global -->
                <div class="gf-dropdown-wrap" id="globalFilterBar" style="display:none;">
                    <button class="gf-dropdown-btn" id="gfDropBtn" onclick="toggleGfDropdown(event)">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="4" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="20" y2="12"/><line x1="12" y1="18" x2="20" y2="18"/>
                        </svg>
                        <span id="gfDropLabel">Todos</span>
                        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
                    </button>
                    <div class="gf-dropdown-menu" id="gfDropMenu" style="display:none;">
                        <button class="gf-drop-opt active" id="gfAmbos"    onclick="applyGlobalFilter('ambos')">
                            <span class="gf-dot" style="background:#35CCA3;"></span>Todos
                            <span id="gfTotalLabel" class="gf-opt-count"></span>
                        </button>
                        <button class="gf-drop-opt" id="gfAtivos"   onclick="applyGlobalFilter('ativo')">
                            <span class="gf-dot" style="background:#818CF8;"></span>Ativos
                            <span id="gfAtivoCount" class="gf-opt-count"></span>
                        </button>
                        <button class="gf-drop-opt" id="gfInativos" onclick="applyGlobalFilter('inativo')">
                            <span class="gf-dot" style="background:#F87171;"></span>Inativos
                            <span id="gfInativoCount" class="gf-opt-count"></span>
                        </button>
                    </div>
                </div>
                <div class="rt-badge offline" id="rtBadge">
                    <span class="rt-dot"></span>
                    <span id="rtBadgeText">Conectando...</span>
                </div>
                <span class="header-datetime" id="headerDatetime"></span>
            </div>
        </div>
    </header>

    <!-- Body -->
    <div class="rel-body" id="relBody">
        <div class="rel-loading" id="relLoading">
            <div class="rel-spinner"></div>
            <span>Carregando dados em tempo real...</span>
        </div>

        <!-- Conteúdo (oculto até dados chegarem) -->
        <div id="relContent" style="display:none; flex-direction:column; gap: inherit; height:100%;">

            <!-- Distribuição de Planos — faixa full-width -->
            <div class="rel-card" style="flex-shrink:0;">
                <div class="rel-card-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    Distribuição de Planos
                </div>
                <div class="rel-card-body" style="padding: 10px 14px;">
                    <div class="planos-grid" id="planosGrid">
                        <div class="rel-loading"><div class="rel-spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- KPI Row -->
            <div class="kpi-row">
                <div class="kpi-tile">
                    <div class="kpi-tile-icon blue">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div class="kpi-tile-data">
                        <span class="kpi-tile-value" id="kpiTotal">-</span>
                        <span class="kpi-tile-label">Total clientes</span>
                    </div>
                </div>
                <div class="kpi-tile">
                    <div class="kpi-tile-icon green">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div class="kpi-tile-data">
                        <span class="kpi-tile-value" id="kpiEmDia">-</span>
                        <span class="kpi-tile-label">Em dia</span>
                    </div>
                </div>
                <div class="kpi-tile">
                    <div class="kpi-tile-icon orange">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                    </div>
                    <div class="kpi-tile-data">
                        <span class="kpi-tile-value" id="kpiPerigo">-</span>
                        <span class="kpi-tile-label">Perigo</span>
                    </div>
                </div>
                <div class="kpi-tile">
                    <div class="kpi-tile-icon red">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                    </div>
                    <div class="kpi-tile-data">
                        <span class="kpi-tile-value" id="kpiRisco">-</span>
                        <span class="kpi-tile-label">Risco Iminente</span>
                    </div>
                </div>
                <div class="kpi-tile">
                    <div class="kpi-tile-icon yellow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                    </div>
                    <div class="kpi-tile-data">
                        <span class="kpi-tile-value" id="kpiErros">-</span>
                        <span class="kpi-tile-label">Com erros</span>
                    </div>
                </div>
                <div class="kpi-tile">
                    <div class="kpi-tile-icon purple">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                    </div>
                    <div class="kpi-tile-data">
                        <span class="kpi-tile-value" id="kpiSemAcesso">-</span>
                        <span class="kpi-tile-label">Sem acesso +30d</span>
                    </div>
                </div>
            </div>

            <!-- Main grid -->
            <div class="main-grid">

                <!-- LEFT -->
                <div class="left-col">
                    <!-- Especialistas -->
                    <div class="rel-card" style="flex: 1.4; min-height:0;">
                        <div class="rel-card-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            Especialistas
                        </div>
                        <div class="rel-card-body" id="espContainer">
                            <div class="rel-loading"><div class="rel-spinner"></div></div>
                        </div>
                    </div>

                    <!-- HealthScore Donut -->
                    <div class="rel-card" style="flex: 1; min-height:0;">
                        <div class="rel-card-title">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                            </svg>
                            HealthScore Geral
                        </div>
                        <div class="rel-card-body" style="display:flex; align-items:center; justify-content:center; padding: 10px 14px;">
                            <div class="hs-chart-wrap">
                                <canvas class="hs-chart-canvas" id="hsChart" width="130" height="130"></canvas>
                                <div class="hs-legend" id="hsLegend"></div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- RIGHT -->
                <div class="right-col">
                    <div class="rel-card" style="flex:1; min-height:0;">
                        <!-- Tabs + Busca -->
                        <div class="rel-card-title" style="gap:0; padding-bottom:0; border-bottom: none;">
                            <button class="client-tab active" id="tabRisco" onclick="setClientFilter('risco')">
                                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                                </svg>
                                Em Risco
                                <span id="riscoCount" class="tab-badge badge-red"></span>
                            </button>
                            <button class="client-tab" id="tabAcesso" onclick="setClientFilter('acesso')">
                                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                                </svg>
                                Sem Acesso
                                <span id="semAcessoCount" class="tab-badge badge-purple"></span>
                            </button>
                            <button class="client-tab" id="tabEmDia" onclick="setClientFilter('emdia')">
                                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                                Em Dia
                                <span id="emDiaCount" class="tab-badge badge-green"></span>
                            </button>

                            <!-- Busca por CNPJ -->
                            <div class="cnpj-search-wrap">
                                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                </svg>
                                <input type="text" id="cnpjSearch" class="cnpj-search-input" placeholder="Buscar CNPJ..." oninput="filterByCnpj(this.value)">
                                <button class="cnpj-search-clear" id="cnpjClear" onclick="clearCnpjSearch()" style="display:none;">✕</button>
                            </div>
                        </div>

                        <!-- Painel Risco -->
                        <div class="rel-card-body client-panel" id="painelRisco">
                            <table class="risco-table">
                                <thead>
                                    <tr>
                                        <th onclick="sortRiscoBy('cnpj')">CNPJ / Cliente<i class="sort-arrow" id="sarr-cnpj">↕</i></th>
                                        <th onclick="sortRiscoBy('especialista')">Especialista<i class="sort-arrow" id="sarr-especialista">↕</i></th>
                                        <th onclick="sortRiscoBy('plano')">Plano<i class="sort-arrow" id="sarr-plano">↕</i></th>
                                        <th onclick="sortRiscoBy('health')">HealthScore<i class="sort-arrow" id="sarr-health">↕</i></th>
                                        <th onclick="sortRiscoBy('ultimoAcesso')">Último Acesso<i class="sort-arrow" id="sarr-ultimoAcesso">↕</i></th>
                                        <th onclick="sortRiscoBy('erros')">Erros<i class="sort-arrow" id="sarr-erros">↕</i></th>
                                    </tr>
                                </thead>
                                <tbody id="riscoTbody"></tbody>
                            </table>
                        </div>

                        <!-- Painel Sem Acesso -->
                        <div class="rel-card-body client-panel" id="painelAcesso" style="display:none;">
                            <div class="rel-loading" id="semAcessoLoading"><div class="rel-spinner"></div></div>
                            <div id="semAcessoContainer"></div>
                        </div>

                        <!-- Painel Em Dia -->
                        <div class="rel-card-body client-panel" id="painelEmDia" style="display:none;">
                            <table class="risco-table">
                                <thead>
                                    <tr>
                                        <th onclick="sortEmDiaBy('cnpj')">CNPJ / Cliente<i class="sort-arrow" id="edarr-cnpj">↕</i></th>
                                        <th onclick="sortEmDiaBy('especialista')">Especialista<i class="sort-arrow" id="edarr-especialista">↕</i></th>
                                        <th onclick="sortEmDiaBy('plano')">Plano<i class="sort-arrow" id="edarr-plano">↕</i></th>
                                        <th onclick="sortEmDiaBy('ultimoAcesso')">Último Acesso<i class="sort-arrow" id="edarr-ultimoAcesso">↕</i></th>
                                        <th onclick="sortEmDiaBy('erros')">Erros<i class="sort-arrow" id="edarr-erros">↕</i></th>
                                    </tr>
                                </thead>
                                <tbody id="emDiaTbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

</div><!-- /container -->

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="js/firebase-config.js"></script>

<script>
// ============================================================
// SIDEBAR
// ============================================================
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    sidebar.classList.toggle('active');
    overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
    document.body.style.overflowY = sidebar.classList.contains('active') ? 'hidden' : '';
}
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const sidebar = document.getElementById('sidebar');
        if (sidebar.classList.contains('active')) toggleSidebar();
    }
});
setTimeout(function() { document.getElementById('sidebar').classList.add('ready'); }, 100);

// ============================================================
// DATETIME
// ============================================================
function updateDatetime() {
    const el = document.getElementById('headerDatetime');
    if (!el) return;
    const now = new Date();
    el.textContent = now.toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: 'short' })
                   + ' ' + now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}
updateDatetime();
setInterval(updateDatetime, 30000);

// ============================================================
// NORMALIZAÇÃO DE HEALTHSCORE
// ============================================================
const HS_CONFIG = {
    'em dia':        { label: 'Em dia',         cls: 'em-dia',  color: '#35CCA3' },
    'perigo':        { label: 'Perigo',         cls: 'perigo',  color: '#FB923C' },
    'risco iminente':{ label: 'Risco Iminente', cls: 'risco',   color: '#F87171' },
};

const _nhCache = new Map();
function normalizeHealth(h) {
    if (!h) return { label: 'Sem dado', cls: 'outros', color: '#6B7280' };
    if (_nhCache.has(h)) return _nhCache.get(h);
    const key = h.toLowerCase().trim().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    let result = { label: h, cls: 'outros', color: '#6B7280' };
    for (const k in HS_CONFIG) {
        const kn = k.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        if (key.includes(kn)) { result = HS_CONFIG[k]; break; }
    }
    _nhCache.set(h, result);
    return result;
}

function healthBadge(h) {
    const cfg = normalizeHealth(h);
    return `<span class="badge-health ${cfg.cls}">${cfg.label}</span>`;
}

// ============================================================
// CONVERTER FIREBASE ROWS → OBJETOS
// ============================================================
function convertRows(data) {
    if (!data || !data.rows || !data.headers) return [];
    const headers = data.headers;
    return data.rows.map(function(row) {
        const obj = {};
        headers.forEach(function(h, i) { obj[h] = row[i] || ''; });
        return obj;
    });
}

// ============================================================
// FOTO MAP
// ============================================================
let fotoMap = {};

function buildFotoMap(colaboradores) {
    fotoMap = {};
    if (!colaboradores) return;
    colaboradores.forEach(function(c) {
        if (c.nome) fotoMap[c.nome.trim().toLowerCase()] = c.imagem || '';
    });
}

function getFoto(nome) {
    return fotoMap[(nome || '').trim().toLowerCase()] || '';
}

function avatarHtml(nome, size) {
    const foto = getFoto(nome);
    const sz = size || 20;
    if (foto) return `<img src="${foto}" class="esp-tag-avatar" style="width:${sz}px;height:${sz}px;" onerror="this.style.display='none'">`;
    return '';
}

// ============================================================
// RENDER KPIs
// ============================================================
function renderKPIs(stats) {
    if (!stats) return;
    const hs = stats.healthScore || {};
    let emDia = 0, perigo = 0, risco = 0;
    for (const k in hs) {
        const cfg = normalizeHealth(k);
        if (cfg.cls === 'em-dia') emDia += hs[k];
        else if (cfg.cls === 'perigo') perigo += hs[k];
        else if (cfg.cls === 'risco') risco += hs[k];
    }
    document.getElementById('kpiTotal').textContent    = stats.total || 0;
    document.getElementById('kpiEmDia').textContent    = emDia;
    document.getElementById('kpiPerigo').textContent   = perigo;
    document.getElementById('kpiRisco').textContent    = risco;
    document.getElementById('kpiErros').textContent    = stats.comErros || 0;
    document.getElementById('kpiSemAcesso').textContent = stats.semAcessoRecente || 0;
}

// ============================================================
// RENDER ESPECIALISTAS
// ============================================================
function renderEspecialistas(stats) {
    const container = document.getElementById('espContainer');
    const esp = stats.especialistasArray || [];
    if (!esp.length) { container.innerHTML = '<p style="color:#6B7280;font-size:0.85em;">Sem dados</p>'; return; }

    const hs = stats.healthScore || {};
    const total = stats.total || 1;

    let html = '';
    esp.forEach(function(e) {
        const foto = e.foto || getFoto(e.nome);
        const avatarEl = foto
            ? `<img src="${foto}" class="esp-avatar" alt="${e.nome}" onerror="this.outerHTML='<div class=esp-avatar-placeholder>${e.nome.charAt(0)}</div>'">`
            : `<div class="esp-avatar-placeholder">${(e.nome || '?').charAt(0)}</div>`;

        // Calcular health breakdown para barra
        const ehs = e.healthScore || {};
        let emDia = 0, peri = 0, risc = 0, outros = 0;
        for (const k in ehs) {
            const cfg = normalizeHealth(k);
            if (cfg.cls === 'em-dia') emDia += ehs[k];
            else if (cfg.cls === 'perigo') peri += ehs[k];
            else if (cfg.cls === 'risco') risc += ehs[k];
            else outros += ehs[k];
        }
        const tot = e.total || 1;
        const subParts = [];
        if (peri > 0)  subParts.push(`<span style="color:#FB923C;">${peri} perigo</span>`);
        if (risc > 0)  subParts.push(`<span style="color:#F87171;">${risc} risco</span>`);
        if (e.comErros > 0) subParts.push(`<span style="color:#EAB308;">${e.comErros} c/ erro</span>`);

        const bars = [
            { pct: emDia/tot*100, color:'#35CCA3' },
            { pct: peri/tot*100,  color:'#FB923C' },
            { pct: risc/tot*100,  color:'#F87171' },
            { pct: outros/tot*100,color:'#6B7280'  }
        ].filter(b => b.pct > 0);

        const barsHtml = bars.map(b =>
            `<div class="esp-health-seg" style="flex:${b.pct};background:${b.color};"></div>`
        ).join('');

        html += `
        <div class="especialista-item">
            ${avatarEl}
            <div class="esp-info">
                <div class="esp-name">${e.nome}</div>
                <div class="esp-sub">${subParts.length ? subParts.join(' · ') : '<span style="color:#35CCA3">Todos em dia</span>'}</div>
                <div class="esp-health-bar">${barsHtml}</div>
            </div>
            <div class="esp-total">${e.total}</div>
        </div>`;
    });

    container.innerHTML = html;
}

// ============================================================
// RENDER HEALTHSCORE CHART
// ============================================================
let hsChartInstance = null;

function renderHSChart(stats) {
    const hs = stats.healthScore || {};
    const total = stats.total || 1;

    // Agrupar por categoria normalizada
    const groups = { 'em-dia': 0, 'perigo': 0, 'risco': 0, 'outros': 0 };
    const groupLabels = { 'em-dia': 'Em dia', 'perigo': 'Perigo', 'risco': 'Risco Iminente', 'outros': 'Outros' };
    const groupColors = { 'em-dia': '#35CCA3', 'perigo': '#FB923C', 'risco': '#F87171', 'outros': '#6B7280' };

    for (const k in hs) {
        const cfg = normalizeHealth(k);
        groups[cfg.cls] = (groups[cfg.cls] || 0) + hs[k];
    }

    const labels = [], data = [], colors = [];
    for (const k in groups) {
        if (groups[k] > 0) {
            labels.push(groupLabels[k]);
            data.push(groups[k]);
            colors.push(groupColors[k]);
        }
    }

    const ctx = document.getElementById('hsChart').getContext('2d');
    if (hsChartInstance) {
        hsChartInstance.data.labels = labels;
        hsChartInstance.data.datasets[0].data = data;
        hsChartInstance.data.datasets[0].backgroundColor = colors;
        hsChartInstance.update('none');
    } else {
        hsChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0, hoverOffset: 4 }] },
            options: {
                cutout: '68%',
                plugins: { legend: { display: false }, tooltip: { callbacks: {
                    label: function(c) { return ' ' + c.label + ': ' + c.raw + ' (' + Math.round(c.raw/total*100) + '%)'; }
                }}},
                animation: { duration: 400 }
            }
        });
    }

    // Legend
    const legend = document.getElementById('hsLegend');
    legend.innerHTML = labels.map(function(l, i) {
        const pct = Math.round(data[i]/total*100);
        return `<div class="hs-legend-item">
            <div class="hs-legend-dot" style="background:${colors[i]};"></div>
            <span class="hs-legend-label">${l}</span>
            <span class="hs-legend-count">${data[i]}<span class="hs-legend-pct">${pct}%</span></span>
        </div>`;
    }).join('');
}

// ============================================================
// RENDER PLANOS
// ============================================================
const PLANO_COLORS = { 'professional': '#35CCA3', 'avulso': '#818CF8' };

function renderPlanos(stats) {
    const planos = stats.planos || {};
    const total = stats.total || 1;
    const grid = document.getElementById('planosGrid');

    const entries = Object.entries(planos).sort(function(a, b) { return b[1] - a[1]; });
    if (!entries.length) { grid.innerHTML = '<p style="color:#6B7280;font-size:0.85em;">Sem dados</p>'; return; }

    grid.innerHTML = entries.map(function(entry) {
        const [nome, count] = entry;
        const pct = Math.round(count / total * 100);
        const color = PLANO_COLORS[nome.toLowerCase()] || '#9CA3AF';
        return `<div class="plano-card">
            <span class="plano-name">${nome}</span>
            <span class="plano-count" style="color:${color};">${count}</span>
            <span class="plano-pct">${pct}% dos clientes</span>
            <div class="plano-bar" style="background: linear-gradient(90deg, ${color} ${pct}%, rgba(255,255,255,0.05) ${pct}%);"></div>
        </div>`;
    }).join('');
}

// ============================================================
// SORT — CLIENTES EM RISCO
// ============================================================
let _riscoData = [];
let _lastStats  = null;
let _riscoSortCol = 'health';
let _riscoSortDir = 1; // 1 = asc, -1 = desc

const HEALTH_ORDER = { 'risco': 0, 'perigo': 1, 'outros': 2, 'em-dia': 3 };

function sortRiscoBy(col) {
    if (_riscoSortCol === col) {
        _riscoSortDir *= -1;
    } else {
        _riscoSortCol = col;
        _riscoSortDir = col === 'erros' ? -1 : 1; // erros começa maior→menor
    }
    applyRiscoSort();
    updateSortHeaders('risco');
}

function applyRiscoSort() {
    const col = _riscoSortCol;
    const dir = _riscoSortDir;
    const base = _cnpjQuery ? _riscoData.filter(function(c){ return matchCnpj(c.cnpj); }) : _riscoData;
    const sorted = base.slice().sort(function(a, b) {
        if (col === 'erros') {
            return (b.erros - a.erros) * (dir === -1 ? 1 : -1);
        }
        if (col === 'health') {
            const ao = HEALTH_ORDER[normalizeHealth(a.health).cls] ?? 9;
            const bo = HEALTH_ORDER[normalizeHealth(b.health).cls] ?? 9;
            return (ao - bo) * dir;
        }
        if (col === 'ultimoAcesso') {
            const parseDate = function(s) {
                if (!s) return 0;
                const p = s.split('/');
                return p.length === 3 ? new Date(+p[2], +p[1]-1, +p[0]).getTime() : 0;
            };
            return (parseDate(a.ultimoAcesso) - parseDate(b.ultimoAcesso)) * dir;
        }
        const av = String(a[col] || '').toLowerCase();
        const bv = String(b[col] || '').toLowerCase();
        return av < bv ? -dir : av > bv ? dir : 0;
    });
    drawRiscoRows(sorted);
}

function updateSortHeaders(tipo) {
    if (tipo === 'risco') {
        document.querySelectorAll('.risco-table th').forEach(function(th) {
            th.classList.remove('sort-active');
        });
        const cols = ['cnpj','especialista','plano','health','ultimoAcesso','erros'];
        const idx = cols.indexOf(_riscoSortCol);
        if (idx >= 0) {
            const ths = document.querySelectorAll('.risco-table th');
            if (ths[idx]) ths[idx].classList.add('sort-active');
        }
        cols.forEach(function(c) {
            const el = document.getElementById('sarr-' + c);
            if (!el) return;
            if (c === _riscoSortCol) {
                el.textContent = _riscoSortDir === 1 ? '↑' : '↓';
            } else {
                el.textContent = '↕';
            }
        });
    }
}

// ============================================================
// SORT + RENDER — EM DIA
// ============================================================
let _emDiaData = [];
let _emDiaSortCol = 'cnpj';
let _emDiaSortDir = 1;
const EMDIA_PAGE_SIZE = 150;

function sortEmDiaBy(col) {
    if (_emDiaSortCol === col) { _emDiaSortDir *= -1; }
    else { _emDiaSortCol = col; _emDiaSortDir = col === 'erros' ? -1 : 1; }
    applyEmDiaSort();
    updateSortEmDiaHeaders();
}

function applyEmDiaSort() {
    const col = _emDiaSortCol, dir = _emDiaSortDir;
    const base = _cnpjQuery ? _emDiaData.filter(function(c){ return matchCnpj(c.cnpj); }) : _emDiaData;
    const sorted = base.slice().sort(function(a, b) {
        if (col === 'erros') return (b.erros - a.erros) * (dir === -1 ? 1 : -1);
        if (col === 'ultimoAcesso') {
            const pd = function(s) { if (!s) return 0; const p = s.split('/'); return p.length===3 ? new Date(+p[2],+p[1]-1,+p[0]).getTime() : 0; };
            return (pd(a.ultimoAcesso) - pd(b.ultimoAcesso)) * dir;
        }
        const av = String(a[col]||'').toLowerCase(), bv = String(b[col]||'').toLowerCase();
        return av < bv ? -dir : av > bv ? dir : 0;
    });
    drawEmDiaRows(sorted);
}

function updateSortEmDiaHeaders() {
    const cols = ['cnpj','especialista','plano','ultimoAcesso','erros'];
    document.querySelectorAll('#painelEmDia .risco-table th').forEach(function(th) { th.classList.remove('sort-active'); });
    const idx = cols.indexOf(_emDiaSortCol);
    if (idx >= 0) { const ths = document.querySelectorAll('#painelEmDia .risco-table th'); if(ths[idx]) ths[idx].classList.add('sort-active'); }
    cols.forEach(function(c) {
        const el = document.getElementById('edarr-' + c);
        if (!el) return;
        el.textContent = c === _emDiaSortCol ? (_emDiaSortDir === 1 ? '↑' : '↓') : '↕';
    });
}

function drawEmDiaRows(lista) {
    const tbody = document.getElementById('emDiaTbody');
    if (!lista.length) { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:20px;color:#6B7280;font-size:0.9em;">Sem dados</td></tr>`; return; }
    tbody.innerHTML = lista.map(function(c) {
        const foto = getFoto(c.especialista);
        const fotoEl = foto ? `<img src="${foto}" class="esp-tag-avatar" onerror="this.style.display='none'">` : '';
        const erroEl = c.erros > 0 ? `<span class="badge-erros">${c.erros}</span>` : `<span class="badge-erros zero">0</span>`;
        return `<tr>
            <td style="font-family:monospace;font-size:0.9em;color:#E7E7E7;">${c.cnpj}</td>
            <td><div class="esp-tag">${fotoEl}<span class="esp-tag-name">${c.especialista||'—'}</span></div></td>
            <td style="color:#9CA3AF;">${c.plano||'—'}</td>
            <td style="color:#9CA3AF;font-size:0.9em;">${c.ultimoAcesso||'—'}</td>
            <td>${erroEl}</td>
        </tr>`;
    }).join('');
}

function renderEmDia(stats) {
    _emDiaData = stats.clientesEmDia || [];
    document.getElementById('emDiaCount').textContent = _emDiaData.length;
    _emDiaSortCol = 'cnpj'; _emDiaSortDir = 1;
    applyEmDiaSort();
    updateSortEmDiaHeaders();
}

// ============================================================
// RENDER CLIENTES EM RISCO
// ============================================================
const RISCO_PAGE_SIZE = 150;

function drawRiscoRows(lista) {
    const tbody = document.getElementById('riscoTbody');
    if (!lista.length) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:20px;color:#35CCA3;font-size:0.9em;">Nenhum cliente em risco</td></tr>`;
        return;
    }
    tbody.innerHTML = lista.map(function(c) {
        const foto = getFoto(c.especialista);
        const fotoEl = foto ? `<img src="${foto}" class="esp-tag-avatar" onerror="this.style.display='none'">` : '';
        const erroEl = c.erros > 0
            ? `<span class="badge-erros">${c.erros}</span>`
            : `<span class="badge-erros zero">0</span>`;
        return `<tr>
            <td style="font-family:monospace;font-size:0.9em;color:#E7E7E7;">${c.cnpj}</td>
            <td><div class="esp-tag">${fotoEl}<span class="esp-tag-name">${c.especialista || '—'}</span></div></td>
            <td style="color:#9CA3AF;">${c.plano || '—'}</td>
            <td>${healthBadge(c.health)}</td>
            <td style="color:#9CA3AF;font-size:0.9em;">${c.ultimoAcesso || '—'}</td>
            <td>${erroEl}</td>
        </tr>`;
    }).join('');

}

function renderRisco(stats) {
    _riscoData = stats.clientesRisco || [];
    document.getElementById('riscoCount').textContent = _riscoData.length;
    _riscoSortCol = 'health';
    _riscoSortDir = 1;
    applyRiscoSort();
    updateSortHeaders('risco');
}

// ============================================================
// RENDER SEM ACESSO RECENTE (usa lista pré-computada em computeStatsFromRows)
// ============================================================
const ACESSO_PAGE_SIZE = 150;

function renderSemAcessoRows(lista) {
    const container = document.getElementById('semAcessoContainer');
    if (!lista.length) {
        container.innerHTML = '<p style="color:#35CCA3;font-size:0.85em;padding:8px;">Nenhum resultado.</p>';
        return;
    }
    container.innerHTML = lista.map(function(c) {
        const diasText = c.dias >= 9999 ? 'Nunca acessou' : c.dias + ' dias';
        const cls = c.dias >= 9999 ? 'nunca' : c.dias >= 60 ? 'critico' : 'atencao';
        const foto = getFoto(c.especialista);
        const fotoEl = foto ? `<img src="${foto}" class="esp-tag-avatar" onerror="this.style.display='none'" style="width:18px;height:18px;">` : '';
        return `<div class="acesso-item">
            <div style="flex:1;min-width:0;">
                <div class="acesso-cnpj">${c.cnpj || '—'}</div>
                <div class="acesso-esp" style="display:flex;align-items:center;gap:4px;">${fotoEl}${c.especialista || '—'} · ${healthBadge(c.health)}</div>
            </div>
            <span class="acesso-dias ${cls}">${diasText}</span>
        </div>`;
    }).join('');
}

function renderSemAcesso(stats) {
    const loading = document.getElementById('semAcessoLoading');
    if (loading) loading.style.display = 'none';
    document.getElementById('semAcessoCount').textContent = (stats.semAcessoList || []).length;
    const lista = (stats.semAcessoList || []).filter(function(c) { return matchCnpj(c.cnpj); });
    renderSemAcessoRows(lista.length === (stats.semAcessoList || []).length ? lista : lista);
    // store for later filter
    _lastStats = stats;
}

// ============================================================
// BUSCA POR CNPJ
// ============================================================
let _cnpjQuery = '';

function filterByCnpj(val) {
    _cnpjQuery = val.trim().toLowerCase().replace(/\D/g, '');
    document.getElementById('cnpjClear').style.display = val ? '' : 'none';
    applyCurrentTabFilter();
}

function clearCnpjSearch() {
    _cnpjQuery = '';
    document.getElementById('cnpjSearch').value = '';
    document.getElementById('cnpjClear').style.display = 'none';
    applyCurrentTabFilter();
}

function matchCnpj(cnpj) {
    if (!_cnpjQuery) return true;
    return String(cnpj || '').toLowerCase().replace(/\D/g, '').includes(_cnpjQuery);
}

function applyCurrentTabFilter() {
    const tab = document.querySelector('.client-tab.active');
    const tipo = tab ? tab.id.replace('tab','').toLowerCase() : 'risco';
    if (tipo === 'risco') {
        const filtered = _riscoData.filter(function(c) { return matchCnpj(c.cnpj); });
        drawRiscoRows(filtered);
    } else if (tipo === 'acesso') {
        const lista = (_lastStats && _lastStats.semAcessoList) ? _lastStats.semAcessoList : [];
        const filtered = lista.filter(function(c) { return matchCnpj(c.cnpj); });
        renderSemAcessoRows(filtered);
    } else if (tipo === 'emdia') {
        const filtered = _emDiaData.filter(function(c) { return matchCnpj(c.cnpj); });
        drawEmDiaRows(filtered);
    }
}

// ============================================================
// FILTRO DE CLIENTES (tabs)
// ============================================================
function setClientFilter(tipo) {
    document.getElementById('tabRisco').classList.toggle('active',  tipo === 'risco');
    document.getElementById('tabAcesso').classList.toggle('active', tipo === 'acesso');
    document.getElementById('tabEmDia').classList.toggle('active',  tipo === 'emdia');
    document.getElementById('painelRisco').style.display  = tipo === 'risco'  ? '' : 'none';
    document.getElementById('painelAcesso').style.display = tipo === 'acesso' ? '' : 'none';
    document.getElementById('painelEmDia').style.display  = tipo === 'emdia'  ? '' : 'none';
}

// ============================================================
// RT STATUS
// ============================================================
function setRtStatus(online, text) {
    const badge = document.getElementById('rtBadge');
    const label = document.getElementById('rtBadgeText');
    badge.className = 'rt-badge' + (online ? '' : ' offline');
    label.textContent = text;
}

// ============================================================
// ENCONTRAR COLUNA pelo nome (flexível, ignora typos parciais)
// ============================================================
function findHeader(headers, candidates) {
    const norm = function(s) {
        return String(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
    };
    for (let i = 0; i < headers.length; i++) {
        const h = norm(headers[i]);
        for (let j = 0; j < candidates.length; j++) {
            const c = norm(candidates[j]);
            if (h.includes(c) || c.includes(h)) return headers[i];
        }
    }
    return null;
}

// ============================================================
// COMPUTAR STATS A PARTIR DOS DADOS BRUTOS (client-side)
// Garante cálculo correto independente de typos no Apps Script
// ============================================================
function computeStatsFromRows(rows) {
    if (!rows.length) return { total: 0, healthScore: {}, planos: {}, especialistasArray: [], comErros: 0, semAcessoRecente: 0, clientesRisco: [], clientesEmDia: [] };

    const headers = Object.keys(rows[0]);
    const hEsp    = findHeader(headers, ['especialista', 'responsavel']);
    const hPlano  = findHeader(headers, ['plano']);
    const hHealth = findHeader(headers, ['healthscore', 'healtscore', 'healt', 'health', 'saude']);
    const hAcesso = findHeader(headers, ['ultimo acesso', 'ultimo_acesso', 'acesso']);
    const hErros  = findHeader(headers, ['qtd verificando', 'verificando', 'erro']);
    const hCNPJ   = findHeader(headers, ['cnpj']);
    const hStatus = findHeader(headers, ['status', 'situacao', 'situação', 'ativo', 'inativo', 'situacao_cliente']);

    const hoje = new Date();
    const stats = {
        total: rows.length,
        healthScore: {},
        planos: {},
        especialistas: {},
        comErros: 0,
        semAcessoRecente: 0,
        semAcessoList: [],
        clientesRisco: [],
        clientesEmDia: []
    };

    rows.forEach(function(row) {
        const esp    = hEsp    ? String(row[hEsp]    || '').trim() : '';
        const plano  = hPlano  ? String(row[hPlano]  || '').trim() : '';
        const health = hHealth ? String(row[hHealth] || '').trim() : '';
        const acesso = hAcesso ? String(row[hAcesso] || '').trim() : '';
        const erros  = hErros  ? parseInt(row[hErros]) || 0 : 0;
        const cnpj   = hCNPJ   ? String(row[hCNPJ]   || '').trim() : '';
        const status = hStatus  ? normalizeStatus(String(row[hStatus] || '')) : 'ativo';

        // HealthScore
        if (health) stats.healthScore[health] = (stats.healthScore[health] || 0) + 1;

        // Planos
        if (plano) stats.planos[plano] = (stats.planos[plano] || 0) + 1;

        // Especialistas
        if (esp) {
            if (!stats.especialistas[esp]) {
                stats.especialistas[esp] = { nome: esp, total: 0, healthScore: {}, comErros: 0, foto: getFoto(esp) };
            }
            stats.especialistas[esp].total++;
            if (health) stats.especialistas[esp].healthScore[health] = (stats.especialistas[esp].healthScore[health] || 0) + 1;
            if (erros > 0) stats.especialistas[esp].comErros++;
        }

        // Com erros
        if (erros > 0) stats.comErros++;

        // Sem acesso recente (> 30 dias ou nunca acessou)
        let dias = null;
        if (!acesso) {
            dias = 9999;
        } else {
            const parts = acesso.split('/');
            if (parts.length === 3) {
                const d = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                if (!isNaN(d.getTime())) dias = Math.floor((hoje - d) / 86400000);
            }
        }
        if (dias !== null && dias > 30 && status !== 'inativo') {
            stats.semAcessoRecente++;
            stats.semAcessoList.push({ cnpj, especialista: esp, health, ultimoAcesso: acesso, dias });
        }

        // Clientes em risco / em dia
        const hn = normalizeHealth(health);
        if (hn.cls === 'perigo' || hn.cls === 'risco') {
            stats.clientesRisco.push({ cnpj, especialista: esp, plano, health, ultimoAcesso: acesso, erros });
        } else if (hn.cls === 'em-dia') {
            stats.clientesEmDia.push({ cnpj, especialista: esp, plano, health, ultimoAcesso: acesso, erros });
        }
    });

    // Especialistas → array ordenado
    stats.especialistasArray = Object.values(stats.especialistas).sort(function(a, b) { return b.total - a.total; });
    delete stats.especialistas;

    // Risco: Risco Iminente primeiro (normalizeHealth já cacheada)
    stats.clientesRisco.sort(function(a, b) {
        const ac = normalizeHealth(a.health).cls === 'risco' ? 0 : 1;
        const bc = normalizeHealth(b.health).cls === 'risco' ? 0 : 1;
        return ac - bc;
    });

    // Sem acesso: mais dias primeiro
    stats.semAcessoList.sort(function(a, b) { return b.dias - a.dias; });

    return stats;
}

// ============================================================
// FILTRO GLOBAL (ativo / inativo / ambos)
// ============================================================
let _allRows = [];
let _globalFilter = 'ambos';
let _hStatus = null;

function detectStatusHeader(rows) {
    if (!rows.length) return null;
    return findHeader(Object.keys(rows[0]), ['status', 'situacao', 'situação', 'ativo', 'inativo', 'situacao_cliente']);
}

function normalizeStatus(val) {
    if (!val) return 'desconhecido';
    const v = String(val).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
    if (v === 'nao' || v === 'n' || v === 'inativo' || v.includes('inativo')) return 'inativo';
    if (v === 'sim' || v === 's' || v === 'ativo'   || v.includes('ativo'))   return 'ativo';
    return 'desconhecido';
}

function filterRows(rows, filter) {
    if (filter === 'ambos' || !_hStatus) return rows;
    return rows.filter(function(row) {
        return normalizeStatus(_hStatus ? row[_hStatus] : '') === filter;
    });
}

function toggleGfDropdown(e) {
    e.stopPropagation();
    const menu = document.getElementById('gfDropMenu');
    const btn  = document.getElementById('gfDropBtn');
    const open = menu.style.display === 'none';
    menu.style.display = open ? '' : 'none';
    btn.classList.toggle('open', open);
}

document.addEventListener('click', function() {
    const menu = document.getElementById('gfDropMenu');
    const btn  = document.getElementById('gfDropBtn');
    if (menu) menu.style.display = 'none';
    if (btn)  btn.classList.remove('open');
});

function updateGfCounts() {
    const total   = _allRows.length;
    const ativos  = _hStatus ? _allRows.filter(function(r) { return normalizeStatus(r[_hStatus]) === 'ativo'; }).length   : total;
    const inativos= _hStatus ? _allRows.filter(function(r) { return normalizeStatus(r[_hStatus]) === 'inativo'; }).length : 0;
    const elTotal  = document.getElementById('gfTotalLabel');
    const elAtivo  = document.getElementById('gfAtivoCount');
    const elInativo= document.getElementById('gfInativoCount');
    if (elTotal)   elTotal.textContent   = total;
    if (elAtivo)   elAtivo.textContent   = ativos;
    if (elInativo) elInativo.textContent = inativos;
}

function applyGlobalFilter(filter) {
    _globalFilter = filter;

    // Fechar dropdown
    document.getElementById('gfDropMenu').style.display = 'none';
    document.getElementById('gfDropBtn').classList.remove('open');

    // Label do botão
    const labels = { ambos: 'Todos', ativo: 'Ativos', inativo: 'Inativos' };
    document.getElementById('gfDropLabel').textContent = labels[filter] || 'Todos';

    // Highlight opção ativa
    ['gfAmbos','gfAtivos','gfInativos'].forEach(function(id) {
        document.getElementById(id).classList.remove('active');
    });
    const activeId = { ambos: 'gfAmbos', ativo: 'gfAtivos', inativo: 'gfInativos' }[filter];
    if (activeId) document.getElementById(activeId).classList.add('active');

    const filtered = filterRows(_allRows, filter);
    const stats = computeStatsFromRows(filtered);
    renderKPIs(stats);
    renderEspecialistas(stats);
    renderHSChart(stats);
    renderPlanos(stats);
    requestAnimationFrame(function() {
        renderRisco(stats);
        renderSemAcesso(stats);
        renderEmDia(stats);
    });
}

// ============================================================
// FIREBASE LISTENER
// ============================================================
let lastChecksum = '';
let renderTimer = null;

function processAndRender(data) {
    buildFotoMap(data.colaboradores);
    _allRows = convertRows(data);
    _hStatus = detectStatusHeader(_allRows);

    // Mostrar dropdown filtro global só se houver coluna de status
    const filterBar = document.getElementById('globalFilterBar');
    if (filterBar) filterBar.style.display = _hStatus ? '' : 'none';

    updateGfCounts();
    const filtered = filterRows(_allRows, _globalFilter);
    const stats = computeStatsFromRows(filtered);

    renderKPIs(stats);
    renderEspecialistas(stats);
    renderHSChart(stats);
    renderPlanos(stats);

    // Adiar tabelas pesadas para o próximo frame — KPIs e especialistas já visíveis
    requestAnimationFrame(function() {
        renderRisco(stats);
        renderSemAcesso(stats);
        renderEmDia(stats);
    });

    document.getElementById('relLoading').style.display = 'none';
    document.getElementById('relContent').style.display = 'flex';

    const time = data.updatedISO ? new Date(data.updatedISO).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
    setRtStatus(true, 'Tempo real · ' + _allRows.length + ' clientes' + (time ? ' · ' + time : ''));
}

function startRelacionamentoListener() {
    if (typeof database === 'undefined' || !database) return;

    database.ref('relacionamento_live').on('value', function(snapshot) {
        if (!snapshot.exists()) {
            setRtStatus(false, 'Aguardando dados...');
            return;
        }

        const data = snapshot.val();
        if (!data || !data.rows || !data.headers) return;
        if (data.source !== 'apps_script' && data.source !== 'apps_script_bulk') return;

        const newChecksum = data.checksum || String(data.updatedAt || '');
        if (newChecksum === lastChecksum) return;
        lastChecksum = newChecksum;

        // Debounce: evita múltiplos renders em sequência rápida
        if (renderTimer) clearTimeout(renderTimer);
        renderTimer = setTimeout(function() { processAndRender(data); }, 80);
    });
}

// Iniciar quando Firebase estiver pronto
window.addEventListener('firebaseReady', function() {
    startRelacionamentoListener();
});

if (typeof isFirebaseReady === 'function' && isFirebaseReady()) {
    startRelacionamentoListener();
}
</script>
</body>
</html>
